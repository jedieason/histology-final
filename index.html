<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="國立臺灣大學醫學系組織學期末">
    <meta name="keywords" content="組織學期末跑台機">
    <link rel="icon" href="icon.png" type="image/png">
    <script type="text/JavaScript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <title>組織學期末跑台</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .doc-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .doc-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            color: var(--text-primary);
            padding: 30px;
            overflow-y: auto;
            box-shadow: none;
            border: none;
            border-radius: 0;
            z-index: 2001;
        }

        body.dark-mode .doc-page {
            background-color: var(--modal-bg);
            color: var(--text-primary);
        }

        #docContent {
            counter-reset: docEntryCounter;
            padding-left: 25px;
        }

        .doc-entry {
            margin: 0 auto 25px auto;
            padding: 0;
            padding-bottom: 20px;
            max-width: 650px;
            border-bottom: 1px solid var(--border-primary);
            position: relative;
        }

        .doc-entry::before {
            counter-increment: docEntryCounter;
            content: counter(docEntryCounter) ".";
            position: absolute;
            left: -25px;
            top: 0;
            width: 20px;
            text-align: right;
            color: var(--text-primary);
        }

        .doc-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .doc-entry img {
            display: block;
            max-width: 150px;
            height: auto;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid var(--border-primary);
            box-shadow: 0 2px 5px var(--shadow-color);
            background-color: var(--bg-secondary);
        }

        .doc-text {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 100%;
        }

        .doc-text p {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-primary);
            margin-bottom: 0;
        }

        .doc-text p strong {
            font-weight: 600;
        }

        .doc-text pre {
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-secondary);
            margin-top: 0;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: inherit;
            background: none;
            padding: 0;
            border: none;
            border-radius: 0;
        }

        @font-face {
            font-family: 'Germgoth';
            src: url('fonts/Germgoth.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            --bg-primary: #FFFFFF;
            --bg-secondary: #FFFFFF;
            --text-primary: #404040;
            --text-secondary: #666;
            --text-muted: #999;
            --heading-color: #383838;
            --border-primary: #EAEAEA;
            --border-secondary: #D8D8D8;
            --accent-blue: #6D8A96;
            --accent-blue-hover: #5A7580;
            --accent-green: #79A88F;
            --accent-orange: #D98C60;
            --accent-red: #C76D6D;
            --shadow-color: rgba(0, 0, 0, 0.07);
            --focus-ring: rgba(109, 138, 150, 0.15);
            --modal-bg: #FDFBF8;
            --card-answer-bg: rgba(249, 247, 243, 0.85);
            --toggle-icon-color: #2C3E50;
            --toggle-moon-mask: #F9F7F3;

            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        body.dark-mode {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-muted: #757575;
            --heading-color: #e0e0e0;
            --border-primary: #383838;
            --border-secondary: #505050;
            --accent-blue: #7aa0b2;
            --accent-blue-hover: #95b9cd;
            --accent-green: #87c7a8;
            --accent-orange: #eaa67a;
            --accent-red: #e08484;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --focus-ring: rgba(122, 160, 178, 0.3);
            --modal-bg: #2a2a2a;
            --card-answer-bg: rgba(42, 42, 42, 0.9);
            --toggle-icon-color: #e0e0e0;
            --toggle-moon-mask: #1e1e1e;
        }

        .flashcard-title, .start-title {
            font-family: "Germgoth", serif;
            color: var(--heading-color);
            font-weight: normal;
            letter-spacing: 0.5px;
            text-align: center;
            padding-bottom: 5px;
            transition: color 0.4s ease;
        }
        .start-title {
            font-size: 2.8rem;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        .start-title::before {
            content: '';
            position: absolute;
            top: 0;
            left: -30%;
            width: 60%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg);
            animation: shine 2.5s infinite;
            filter: blur(4px);
        }
        body.dark-mode .start-title::before {
            background: linear-gradient(to right, transparent, rgba(30,30,30,0.4), transparent);

        }
        .flashcard-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .start-screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%   { box-shadow: 0 0 10px var(--accent-blue); }
            50%  { box-shadow: 0 0 20px var(--accent-blue-hover); }
            100% { box-shadow: 0 0 10px var(--accent-blue); }
        }

        @keyframes shine {
            0%   { left: -50%; }
            100% { left: 150%; }
        }
        .start-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 20px;
            position: relative;
        }

        .start-button {
            padding: 14px 30px;
            font-size: 1.1rem;
            font-weight: 500;
            background-color: var(--accent-blue);
            color: var(--bg-secondary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px var(--shadow-color);
            animation: pulse 2s ease-in-out infinite;
        }
        .start-button:hover {
            background-color: var(--accent-blue-hover);
            box-shadow: 0 4px 8px var(--shadow-color);
            transform: translateY(-2px);
        }
        .start-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px var(--shadow-color);
        }

        /* Resume button: border-only style */
        #resumeButton {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            box-shadow: none;
            animation: none;
        }
        #resumeButton:hover {
            background: var(--bg-secondary);
        }
        body.dark-mode #resumeButton {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-secondary);
        }

        /* Resume progress bar */
        .resume-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }
        .resume-progress-bar {
            width: 220px;
            height: 8px;
            background: var(--border-secondary);
            border-radius: 999px;
            overflow: hidden;
        }
        .resume-progress-fill {
            height: 100%;
            width: 0;
            background: var(--accent-blue);
            transition: width 0.3s ease;
        }
        .resume-progress-text {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        #signInBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #d3d3d3 !important;
            box-shadow: none !important;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 20px;
            z-index: 10;
            transition: transform 0.2s ease;
        }

        #signInBtn:hover {
            transform: scale(1.05);
        }

        /* Dark mode styles for sign in button */
        body.dark-mode #signInBtn {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-primary) !important;
        }

        body.dark-mode #signInBtn:hover {
            background-color: var(--bg-primary) !important;
            border-color: var(--border-secondary) !important;
        }

        #greeting {
            position: absolute;
            top: 28px;
            right: 90px;
            background-color: transparent;
            color: #333333;
            font-size: 14px;
            border-radius: 20px;
            z-index: 10;
        }

        /* Dark mode styles for greeting */
        body.dark-mode #greeting {
            background-color: transparent;
            color: var(--text-primary);
        }
        .edit-nickname-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            margin-left: 6px;
            border: 1px solid var(--border-secondary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }
        .edit-nickname-btn:hover { background: var(--bg-primary); }

        /* 暱稱編輯樣式 */
        #nicknameInput {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: #ffffff;
            color: #333333;
            transition: border-color 0.3s, box-shadow 0.3s;
            width: 100%;
            box-sizing: border-box;
        }

        #nicknameInput:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(121, 168, 143, 0.25);
        }

        #nicknameInput::placeholder {
            color: #999;
        }

        #saveNicknameBtn {
            padding: 12px 24px;
            background-color: var(--accent-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            min-width: 80px;
        }

        #saveNicknameBtn:hover {
            background-color: #6B9B7F;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        #saveNicknameBtn:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }

        #saveNicknameBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 暗色模式下的暱稱編輯樣式 */
        body.dark-mode #nicknameInput {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        body.dark-mode #nicknameInput:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(135, 199, 168, 0.25);
        }

        body.dark-mode #nicknameInput::placeholder {
            color: var(--text-muted);
        }

        body.dark-mode #saveNicknameBtn:disabled {
            background-color: var(--border-primary);
            color: var(--text-muted);
        }

        /* 登入模態框樣式 */
        .login-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .login-modal-content {
            background-color: #ffffff;
            margin: 20px;
            padding: 30px;
            border: none;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .login-modal h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333333;
            font-size: 24px;
            font-weight: 600;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-form input {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: #ffffff;
            color: #333333;
            transition: border-color 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(121, 168, 143, 0.25);
        }

        .login-form button {
            padding: 15px;
            background-color: var(--accent-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-form button:hover {
            background-color: #6B9B7F;
        }

        .login-form button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* 登入方式分隔線 */
        .or-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary, #777);
            font-size: 14px;
        }
        .or-divider::before,
        .or-divider::after {
            content: "";
            flex: 1 1 auto;
            height: 1px;
            background: var(--border-color, #e0e0e0);
        }

        .login-toggle {
            text-align: center;
            margin-top: 20px;
            color: #666666;
        }

        .login-toggle a {
            color: var(--accent-green);
            text-decoration: none;
            cursor: pointer;
        }

        .login-toggle a:hover {
            text-decoration: underline;
        }

        .forgot-password-link {
            color: #e74c3c !important;
            margin-left: 15px;
        }

        .forgot-password-link:hover {
            color: #c0392b !important;
            text-decoration: underline;
        }

        .close-modal {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #999999;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #333333;
        }

        /* Dark mode styles for login modal */
        body.dark-mode .login-modal-content {
            background-color: var(--modal-bg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        body.dark-mode .login-modal h2 {
            color: var(--text-primary);
        }

        body.dark-mode .login-form input {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        body.dark-mode .login-form input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(135, 199, 168, 0.25);
        }

        body.dark-mode .login-form input::placeholder {
            color: var(--text-muted);
        }

        body.dark-mode .login-form button:disabled {
            background-color: var(--border-primary);
            color: var(--text-muted);
        }

        body.dark-mode .login-toggle {
            color: var(--text-secondary);
        }

        body.dark-mode .close-modal {
            color: var(--text-secondary);
        }

        body.dark-mode .close-modal:hover {
            color: var(--text-primary);
        }

        .dropdown-menu {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            position: relative;
            padding-right: 45px;
        }

        .dropdown-toggle::after {
            content: '▲';
            font-size: 0.7em;
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s ease;
        }

        .dropdown-menu.active .dropdown-toggle::after {
            transform: translateY(-50%) rotate(180deg);
        }

        @media (hover: hover) and (pointer: fine) {
            .dropdown-menu:hover .dropdown-toggle::after {
                transform: translateY(-50%) rotate(180deg);
            }
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--bg-secondary);
            min-width: 240px;
            max-height: 520px;
            box-shadow: 0 10px 25px var(--shadow-color);
            z-index: 10;
            border-radius: 8px;
            padding: 8px;
            bottom: -100%;
            left: 50%;
            margin-bottom: 8px;
            transform-origin: bottom center;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #00000030 var(--bg-secondary);
        }

        .dropdown-content::-webkit-scrollbar {
            width: 8px;
        }

        .dropdown-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .dropdown-content::-webkit-scrollbar-thumb {
            background-color: var(--accent-blue);
            border-radius: 4px;
            border: 2px solid var(--bg-secondary);
        }

        .dropdown-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent-blue-hover);
        }


        .dropdown-menu.active .dropdown-content {
            display: block;
            opacity: 0;
            animation: elegantDropdownAppear 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        @media (hover: hover) and (pointer: fine) {
            .dropdown-menu:hover .dropdown-content {
                display: block;
                opacity: 0;
                animation: elegantDropdownAppear 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            }
        }

        @keyframes elegantDropdownAppear {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px) scaleY(0.85);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scaleY(1);
            }
        }

        .dropdown-item {
            width: 100%;
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            background-color: transparent;
            border: none;
            color: var(--text-primary);
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }

        .dropdown-item:not(:last-child) {
            margin-bottom: 4px;
        }

        .dropdown-item:hover {
            background-color: var(--accent-blue-hover);
            color: var(--bg-secondary);
            transform: none;
        }

        .modal-errata-number {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
            margin-bottom: 0;
            font-weight: 400;
            opacity: 0.6;
            transition: color 0.4s ease, opacity 0.4s ease;
        }

        .doc-text .errata-number {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
            margin-bottom: 0;
        }


        .footer {
            position: absolute;
            bottom: 15px;
            width: 100%;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-muted);
            transition: color 0.4s ease;
        }
        .footer a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .footer a:hover {
            color: var(--accent-blue-hover);
            text-decoration: none;
        }

        .day-night-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border-primary);
            background-color: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform 0.2s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .day-night-toggle:focus {
            outline: none;
        }
        .day-night-toggle:hover { transform: scale(1.05); }
        body.dark-mode .day-night-toggle {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-secondary);
        }

        .star-top {
            position: absolute;
            top: 20px;
            left: 76px; /* to the right of day-night toggle */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border-primary);
            background-color: var(--bg-secondary);
            color: #F59E0B; /* yellow star */
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform 0.2s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .star-top:hover { transform: scale(1.05); }
        body.dark-mode .star-top {
            background-color: var(--bg-primary);
            color: #FBBF24; /* brighter yellow for dark mode */
            border: 1px solid var(--border-secondary);
        }

        .toggle-icon {
            width: 30px;
            height: 30px;
            overflow: visible;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toggle-icon .icon-shape {
            fill: var(--toggle-icon-color);
            transition: fill 0.4s ease;
        }
        .toggle-icon .sun-ray {
            stroke: var(--toggle-icon-color);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke 0.4s ease, opacity 0.5s ease;
        }
        .toggle-icon .moon-mask {
            fill: var(--toggle-moon-mask);
            transition: fill 0.4s ease;
        }

        .toggle-icon.rotate {
            transform: rotate(180deg);
        }
        .toggle-icon .sun-rays {
            opacity: 1;
            transition: opacity 0.5s 0.1s ease;
        }
        .toggle-icon .moon-group {
            opacity: 1;
            transition: opacity 0.5s 0.1s ease;
        }

        .toggle-icon.night .sun-rays {
            opacity: 0;
        }
        .toggle-icon.day .moon-group {
            opacity: 0;
        }

        .flashcard-container {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            background-color: var(--bg-primary);
            padding: 25px;
            position: relative;
            max-width: 1400px;
            margin: 0 auto;
            opacity: 0;
            animation: fadeIn 0.6s 0.2s ease-out forwards;
            transition: background-color 0.4s ease;
        }
        .progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 18px;
            gap: 15px;
        }
        .progress-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 500;
            background-color: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            border: 1px solid var(--border-primary);
            flex-shrink: 0;
        }
        @media screen and (max-width: 768px) {
            .progress-item span {
                white-space: nowrap;
                flex-shrink: 0;
            }
        }
        .progress-item:hover {
            background-color: var(--bg-secondary);
            border-color: var(--border-secondary);
            transform: scale(1.03);
        }
        .progress-number-orange {
            margin-right: 8px;
            color: var(--accent-orange);
            font-weight: 600;
            font-size: 1rem;
        }
        .progress-number-green {
            margin-left: 8px;
            color: var(--accent-green);
            font-weight: 600;
            font-size: 1rem;
        }

        .card-content {
            position: relative;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 20px;
            border-radius: 10px;
            background-color: var(--bg-secondary);
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-primary);
            transition: background-color 0.4s ease, box-shadow 0.4s ease, border-color 0.4s ease;
        }
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--bg-secondary-rgb, 255, 255, 255), 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            border-radius: 10px;
            transition: background-color 0.4s ease, opacity 0.3s ease-out;
        }
        body.dark-mode .loading-screen {
            --bg-secondary-rgb: 42, 42, 42;
        }
        .spinner {
            border: 4px solid var(--border-primary);
            border-top: 4px solid var(--accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            transition: border-color 0.4s ease;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-content img {
            display: block;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            border-radius: 10px;
        }
        .card-content img.loaded {
            opacity: 1;
        }

        .star-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 2;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.45);
            color: #ffffff;
            font-size: 20px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
        .star-toggle:hover { transform: scale(1.05); }
        .star-toggle.active {
            color: #F59E0B;
            background: rgba(0, 0, 0, 0.6);
        }

        .your-answer-label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-left: 5px;
            transition: visibility 0s linear 0.3s, opacity 0.3s ease, color 0.4s ease;
        }
        .answer-input-container {
            margin-bottom: 20px;
            transition: visibility 0s linear 0.3s, opacity 0.3s ease;
        }
        .answer-input {
            width: 100%;
            padding: 14px 18px;
            font-size: 1rem;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.4s ease, color 0.4s ease;
            appearance: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) inset;
        }
        .answer-input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
            transition: color 0.4s ease;
        }
        .answer-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--focus-ring), 0 1px 3px rgba(0, 0, 0, 0.05) inset;
        }

        .bottom-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            transition: visibility 0s linear 0.3s, opacity 0.3s ease;
        }
        .dont-know-button, .answer-button {
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        .dont-know-button {
            background-color: transparent;
            color: var(--accent-blue);
            border: 1px solid transparent;
        }
        .dont-know-button:hover {
            color: var(--accent-blue-hover);
            background-color: rgba(var(--accent-blue-rgb, 109, 138, 150), 0.08);
            transform: scale(1.02);
        }
        body.dark-mode .dont-know-button:hover {
            --accent-blue-rgb: 122, 160, 178;
        }
        .answer-button {
            background-color: var(--accent-blue);
            color: var(--bg-secondary);
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        .answer-button:hover {
            background-color: var(--accent-blue-hover);
            box-shadow: 0 4px 8px var(--shadow-color);
            transform: translateY(-2px);
        }
        .dont-know-button:active, .answer-button:active {
            transform: scale(0.98);
            box-shadow: 0 1px 3px var(--shadow-color);
        }

        .card-answer {
            display: none;
            position: absolute;
            bottom: 25px;
            left: 25px;
            right: 25px;
            background-color: var(--card-answer-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 20px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            z-index: 3;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 5px 20px var(--shadow-color);
            opacity: 0;
            transform: translateY(10px);
            animation: fadeSlideIn 0.4s ease-out forwards;
            color: var(--text-primary);
            text-align: center;
            transition: background-color 0.4s ease, color 0.4s ease, box-shadow 0.4s ease;
        }
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #showAnswer strong {
            font-weight: 600;
            margin-right: 5px;
        }
        #showAnswer strong[style*="#10B981"] {
            color: var(--accent-green) !important;
        }
        #showAnswer strong[style*="#EF4444"] {
            color: var(--accent-red) !important;
        }
        #showAnswer strong[style*="#F59E0B"] {
            color: var(--accent-orange) !important;
        }

        .error-number {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
            opacity: 0.6;
            pointer-events: none;
            font-weight: 400;
            transition: color 0.4s ease, opacity 0.4s ease;
        }

        #showExplanation {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: 5px;
            overflow-y: auto;
            overflow: visible;
            transition: color 0.4s ease;
        }
        #showExplanation strong {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.4s ease;
        }
        #showExplanation .contribute-link {
            color: var(--accent-blue);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
            margin-left: 5px;
            transition: color 0.3s ease;
        }
        #showExplanation .contribute-link:hover {
            color: var(--accent-blue-hover);
        }

        .contribution-area {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            transition: border-color 0.4s ease;
        }
        .contribution-area input {
            flex: 1;
            padding: 8px 12px;
            font-size: 1rem;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            outline: none;
            resize: vertical;
            margin-right: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) inset;
            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .contribution-area input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--focus-ring), 0 1px 3px rgba(0, 0, 0, 0.05) inset;
        }
        .contribution-area button {
            padding: 8px 18px;
            font-size: 1rem;
            font-weight: 500;
            background-color: var(--accent-blue);
            color: var(--bg-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            float: right;
        }
        .contribution-area button:hover {
            background-color: var(--accent-blue-hover);
        }
        .contribution-area button:active {
            transform: scale(0.97);
        }
        .contribution-area button.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }
        .contribution-area button.loading::after {
            content: '';
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin-top: -8px;
            margin-left: -8px;
            border: 2px solid rgba(var(--bg-secondary-rgb, 255, 255, 255), 0.4);
            border-top-color: var(--bg-secondary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            transition: border-color 0.4s ease;
        }
        body.dark-mode .contribution-area button.loading::after {
            --bg-secondary-rgb: 42, 42, 42;
            border-top-color: var(--bg-secondary);
        }

        .next-button {
            display: block;
            padding: 10px 22px;
            font-size: 1rem;
            font-weight: 500;
            background-color: transparent;
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            align-self: center;
            margin-top: 15px;
        }
        .next-button:hover {
            background-color: var(--accent-blue);
            color: var(--bg-secondary);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(var(--accent-blue-rgb, 109, 138, 150), 0.2);
        }
        body.dark-mode .next-button:hover {
            --accent-blue-rgb: 122, 160, 178;
        }
        .next-button:active {
            transform: scale(0.97);
            box-shadow: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            opacity: 0;
            animation: fadeInModal 0.4s ease forwards;
            transition: background-color 0.4s ease;
        }
        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            width: 90%;
            max-width: 650px;
            max-height: 85%;
            overflow-y: auto;
            background-color: var(--modal-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow-color);
            position: relative;
            transform: scale(0.95);
            animation: scaleUpModal 0.4s ease forwards;
            transition: background-color 0.4s ease, box-shadow 0.4s ease, border-color 0.4s ease;
            border: 1px solid var(--border-primary);
        }
        #imageModal .modal-content {
            overflow: visible !important;
            scrollbar-width: none;
        }
        #imageModal .modal-content::-webkit-scrollbar {
            display: none;
        }
        .nav-button {
            all: unset;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            pointer-events: auto;
            color: var(--text-primary);
            font-size: 2rem;
            line-height: 1;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            opacity: 0.6;
            transition: opacity 0.3s ease, transform 0.3s ease, color 0.3s ease;
        }
        .nav-left { left: -80px; }
        .nav-right { right: -80px; }
           @keyframes scaleUpModal {
            from { transform: scale(0.95); opacity: 0;}
            to { transform: scale(1); opacity: 1;}
           }
        .close {
            position: absolute;
            top: 13px;
            right: 20px;
            font-size: 2rem;
            font-weight: 300;
            color: var(--text-secondary);
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s ease, transform 0.3s ease;
        }
        .close:hover {
            color: var(--accent-blue-hover);
            transform: rotate(90deg);
        }
        .modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--heading-color);
            font-weight: 600;
            border-bottom: 1px solid var(--border-primary);
            padding-bottom: 10px;
            transition: color 0.4s ease, border-color 0.4s ease;
        }
        .modal-content p {
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 15px;
            color: var(--text-primary);
            transition: color 0.4s ease;
        }
        .modal-content ol {
            padding-left: 25px;
            margin-bottom: 16px;
        }
        .modal-content li {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-primary);
            list-style-type: decimal;
            transition: border-color 0.4s ease;
        }
        .modal-content li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .modal-content li p {
            margin-bottom: 8px;
        }
        .modal-content li p strong {
            color: var(--text-primary);
        }
        .modal-content li em {
            color: var(--text-secondary);
        }
        .modal-content img {
            max-width: 150px;
            height: auto;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-primary);
            display: block;
            box-shadow: 0 2px 5px var(--shadow-color);
            background-color: var(--bg-secondary);
            transition: border-color 0.4s ease, box-shadow 0.4s ease, background-color 0.4s ease;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .answer-input-container[style*="hidden"],
        .bottom-buttons[style*="hidden"],
        .your-answer-label[style*="hidden"] {
            opacity: 0;
            visibility: hidden;
            transition: visibility 0s linear 0.3s, opacity 0.3s ease;
        }

        .player-input {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            margin-bottom: 24px;
        }
        .player-input input {
            width: 100%;
            padding: 10px 16px;
            font-size: 1rem;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color .3s ease, box-shadow .3s ease;
        }
        .player-input input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--focus-ring);
            outline: none;
        }

        .leaderboard {
            width: 100%;
            max-width: 400px;
            margin: 0 0 20px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            box-shadow: 0 2px 6px var(--shadow-color);
            padding: 20px 20px 0;
            height: 250px; 
            overflow-y: auto; 
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: #00000030 var(--bg-secondary);
        }
        
        .leaderboard::-webkit-scrollbar {
            width: 8px;
        }
        
        .leaderboard::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 0 12px 12px 0;
        }
        
        .leaderboard::-webkit-scrollbar-thumb {
            background-color: var(--accent-blue);
            border-radius: 4px;
            border: 2px solid var(--bg-secondary);
        }
        
        .leaderboard::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent-blue-hover);
        }
        
        .leaderboard::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            pointer-events: none;
            background: linear-gradient(transparent, var(--bg-secondary));
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .leaderboard h3 {
            margin-bottom: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--heading-color);
            position: sticky;
            top: 0;
            background-color: var(--bg-secondary);
            z-index: 1;
            padding-bottom: 8px;
        }
        .leaderboard ol {
            padding-left: 0;
            margin: 0;
            padding-bottom: 20px; 
        }
        .leaderboard li {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-primary);
        }
        .leaderboard-rank {
            width: 30px;
            text-align: left;
        }
        .leaderboard-name {
            flex: 1;
            text-align: center;
        }
        .leaderboard-score {
            width: 50px;
            text-align: right;
        }
        .leaderboard li:last-child {
            border-bottom: none;
        }
        .leaderboard li.current-user {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .leaderboard:hover::after {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .tooltip {
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-22%);
            background-color: #000;
            color: #fff;
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 3000;
        }
        .tooltip-arrow {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-22%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #000;
        }
        #no-explanation-message .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        #no-explanation-message:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .alert-modal {
            display: none;
            background-color: var(--modal-bg);
            color: var(--text-primary);
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 20px;
            left: 50%;
            translate: -50%;
            padding-right: 40px;
            z-index: 300000;
        }
        .nav-button {
            background-color: transparent;
            width: auto;
            height: auto;
            color: var(--text-primary);
            font-size: 2rem;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            pointer-events: auto;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 3010;
            border: none;
            outline: none;
            opacity: 0.6;
            appearance: none;
            padding: 0;
        }

        .nav-left { left: -80px; }
        .nav-right { right: -80px; }

        .nav-button::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            background: var(--accent-blue);
            border-radius: 50%;
            opacity: 0;
            transition: width 0.3s ease, height 0.3s ease, opacity 0.3s ease, filter 0.3s ease;
            pointer-events: none;
        }
        .nav-button:hover {
            color: var(--accent-blue);
        }
        .nav-button:hover::before {
            width: 80px;
            height: 80px;
            opacity: 0.4;
            filter: blur(10px);
        }
        @media screen and (max-width: 768px) {
            .progress {
                gap: 0;
            }
            .dropdown-menu.active .dropdown-content {
                display: block;
                opacity: 1;
                visibility: visible;
                transform: translateX(-50%) translateY(0) scaleY(1);
                animation: elegantDropdownAppear 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            }
            #wrongArea span:not(.progress-number-orange),
            #correctArea span:not(.progress-number-green) {
                display: none;
            }
            .progress-number-green {
                margin-left: 0;
            }
            .progress-number-orange {
                margin-right: 0;
            }
        }
    </style>
</head>
<body onload="init();">

    <div class="start-screen">
        <button id="dayNightToggle" class="day-night-toggle" aria-label="切換到夜晚模式">
            <svg id="dayNightIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="toggle-icon day">
            </svg>
        </button>
        <button id="openStarredTop" class="star-top" title="已加星號" aria-label="已加星號" style="display:none;">★</button>
        
        <button id="signInBtn">
            登入
        </button>

        <div class="start-title">histology</div>
          <div class="leaderboard">
            <ol id="boardList" style="list-style:decimal inside; padding:0;"></ol>
          </div>
          <div class="player-input" style="text-align:center;">
          </div>
          <div id="greeting" style="display:none;"></div>
    <div class="start-buttons">
      <div class="dropdown-menu">
          <button class="dropdown-toggle start-button">單元</button>
          <div class="dropdown-content">
            <button class="dropdown-item" data-json="D.json">消化系統</button>
            <button class="dropdown-item" data-json="I.json">上皮組織</button>
            <button class="dropdown-item" data-json="L.json">淋巴系統</button>
            <button class="dropdown-item" data-json="O.json">口腔組織</button>
            <button class="dropdown-item" data-json="R.json">呼吸系統</button>
            <button class="dropdown-item" data-json="S.json">消化腺體</button>
            <button class="dropdown-item" data-json="U.json">泌尿系統</button>
          </div>
      </div>
      <div class="dropdown-menu">
        <button id="openDoc" class="dropdown-toggle start-button">題庫</button>
          <div class="dropdown-content">
            <button class="dropdown-item" data-json="D.json">消化系統</button>
            <button class="dropdown-item" data-json="I.json">上皮組織</button>
            <button class="dropdown-item" data-json="L.json">淋巴系統</button>
            <button class="dropdown-item" data-json="O.json">口腔組織</button>
            <button class="dropdown-item" data-json="R.json">呼吸系統</button>
            <button class="dropdown-item" data-json="S.json">消化腺體</button>
            <button class="dropdown-item" data-json="U.json">泌尿系統</button>
          </div>
      </div>
    </div>
    <div class="progress-actions" style="text-align:center; margin-top:10px; display:none;">
      <button id="resumeButton" class="start-button" style="display:none;">接續上次</button>
      <div id="resumeProgress" class="resume-progress" style="display:none;">
        <div class="resume-progress-bar">
          <div class="resume-progress-fill" id="resumeProgressFill"></div>
        </div>
        <span class="resume-progress-text" id="resumeProgressText">已完成 0%</span>
      </div>
      <div style="margin-top:8px;">
        <span id="restartProgress" style="color:#999;text-decoration:underline;cursor:pointer;">重新開始</span>
      </div>
    </div>
        <div class="footer">
          <a href="https://chromewebstore.google.com/detail/%E5%8F%B0%E5%A4%A7%E9%86%AB%E5%A1%AB%E5%95%8F%E5%8D%B7/ciioeecbkbnmnedkgmkfaicngidogdkj?authuser=0&hl=en" target="_blank">問卷外掛</a> ｜
          <span id="download-block">
            <a href="profile.mobileconfig" download="Parasite.mobileconfig">蘋果下載</a> ｜
          </span>
          <a href="https://line.me/ti/p/~jedieason" target="_blank">問題回報</a>
        </div>
    </div>

    <div class="flashcard-container">
         <div class="progress">
            <div class="progress-item" id="wrongArea">
                <span class="progress-number-orange" id="wrong">0</span>
                <span>錯誤</span>
            </div>
            <div class="progress-item" style="border:none; cursor:default;">
                <span>分數：</span>
                <span id="score-display">0</span>
                <span style="margin: 0 5px;">｜</span>
                <span>排名：</span>
                <span id="rank-display">N/A</span>
            </div>
            <div class="progress-item" id="correctArea">
                <span>正確</span>
                <span class="progress-number-green" id="correct">0</span>
            </div>
        </div>

        <div class="card-content">
            <button id="starToggle" class="star-toggle" aria-label="加入星號">☆</button>
            <div class="loading-screen">
                <div class="spinner"></div>
            </div>
            <img id="image"
                 loading="eager"
                 decoding="async"
                 fetchpriority="high"
                 onload="handleMainImageLoad(this);"
                 src=""
                 alt="Parasite Image">
        </div>

        <div class="card-answer">
            <div id="showAnswer"></div>
            <div id="showExplanation">
            </div>
            <button id="next" class="next-button">下一個</button>
        </div>

        <div class="your-answer-label">這是什麼？</div>
        <div class="answer-input-container">
            <input id="answer" type="text" placeholder="把答案打在這" class="answer-input">
        </div>

        <div class="bottom-buttons">
            <button id="dontKnow" class="dont-know-button">母災</button>
            <button id="submitAnswer" class="answer-button">確定</button>
        </div>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">×</span>
            <div id="modalBody"></div>
        </div>
    </div>
    <div id="starredModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span id="closeStarredModal" class="close">×</span>
            <div id="starredModalBody"></div>
        </div>
    </div>
    <div id="nicknameModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span id="closeNicknameModal" class="close">×</span>
            <h2>編輯暱稱</h2>
            <input type="text" id="nicknameInput" placeholder="請輸入新的暱稱">
            <div class="modal-actions" style="margin-top: 16px; text-align: right;">
                <button id="saveNicknameBtn">儲存</button>
            </div>
        </div>
    </div>
    <div id="alertModal" class="alert-modal" style="display: none;">
        <span class="close" onclick="closeAlertModal()">×</span>
        <div id="alertModalBody"></div>
    </div>
    <div id="docContainer" class="doc-container" style="display:none;">
      <div class="doc-page">
        <span id="closeDoc" class="close">&times;</span>
        <div id="docContent"></div>
      </div>
    </div>

    <div id="imageModal" class="modal" style="z-index:3000;">
      <div class="modal-content">
        <span id="closeImageModal" class="close" style="top: 4px; right: 10px;">&times;</span>
        <button id="prevImageButton" class="nav-button nav-left" aria-label="上一題">‹</button>
        <button id="nextImageButton" class="nav-button nav-right" aria-label="下一題">›</button>
        <img id="modalImage"
             loading="lazy"
             decoding="async"
             src=""
             alt="Image preview"
             style="max-width: 100%; height: auto; border-radius:6px;">
        <div id="modalInfo" style="text-align:center;">
          <p id="modalAnswer" style="font-weight:600;"></p>
          <p id="modalExplanation" style="color:var(--text-secondary); margin-bottom: 4px;"></p>
          <p id="modalNumber" class="modal-errata-number"></p>
        </div>
      </div>
    </div>

    <script type="module">
        let isComposing = false;
        document.addEventListener('compositionstart', () => { isComposing = true; });
        document.addEventListener('compositionend', () => { isComposing = false; });

        const firebaseConfig = {
            apiKey: "AIzaSyAjvO8nSRkKXUp7gopj-X7QsOGRBHTxj1s",
            authDomain: "jedieason-trivia.firebaseapp.com",
            databaseURL: "https://jedieason-trivia-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jedieason-trivia",
            storageBucket: "jedieason-trivia.firebasestorage.app",
            messagingSenderId: "379460583179",
            appId: "1:379460583179:web:c9d36892128bb0ac066c0e",
            measurementId: "G-5NK671LL2Z"
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAnalytics }  from "https://www.gstatic.com/firebasejs/9.17.1/firebase-analytics.js";
        import {
            getDatabase,
            ref,
            query,
            orderByChild,
            limitToLast,
            get,
            set,
            update
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithRedirect,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            updateProfile,
            signOut,
            onAuthStateChanged,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        const app       = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db        = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        // Firebase progress management functions
        async function checkForExistingProgress() {
            let hasProgress = false;
            
            if (window.currentUserUid) {
                // Check Firebase first for logged in users
                try {
                    const firebaseProgress = await loadProgressFromFirebase();
                    if (firebaseProgress) {
                        console.log("[checkForExistingProgress] Found progress in Firebase");
                        hasProgress = true;
                    }
                } catch (error) {
                    console.error("[checkForExistingProgress] Error checking Firebase progress:", error);
                }
            }
            
            // localStorage fallback removed - Firebase only
            
            // Update UI based on progress availability
            if (hasProgress) {
                const resumeEl = document.getElementById('resumeButton');
                const prog = await loadProgressFromFirebase();
                let unitNameText = '單元';
                let percent = 0;
                if (prog && Array.isArray(prog.done) && Array.isArray(prog.data) && prog.data.length > 0) {
                    const total = prog.data.length;
                    const completed = prog.done.filter(Boolean).length;
                    percent = Math.round((completed / total) * 100);
                }
                if (prog && prog.unitName) {
                    unitNameText = prog.unitName;
                }
                if (resumeEl) {
                    resumeEl.textContent = `繼續 ${unitNameText}`;
                    resumeEl.style.display = 'inline-block';
                }
                const resumeProgress = document.getElementById('resumeProgress');
                const fill = document.getElementById('resumeProgressFill');
                const text = document.getElementById('resumeProgressText');
                if (resumeProgress && fill && text) {
                    resumeProgress.style.display = 'flex';
                    fill.style.width = `${percent}%`;
                    text.textContent = `已完成 ${percent}%`;
                }
                document.querySelector('.progress-actions').style.display = 'block';
                document.querySelector('.start-buttons').style.display = 'none';
            } else {
                const resumeEl = document.getElementById('resumeButton');
                if (resumeEl) resumeEl.style.display = 'none';
                const resumeProgress = document.getElementById('resumeProgress');
                if (resumeProgress) resumeProgress.style.display = 'none';
                document.querySelector('.progress-actions').style.display = 'none';
                document.querySelector('.start-buttons').style.display = 'flex';
            }
            
            return hasProgress;
        }
        
        async function saveProgressToFirebase(progressData) {
            if (!window.currentUserUid) {
                console.warn("[saveProgressToFirebase] No user logged in, cannot save progress to Firebase");
                return false;
            }
            
            try {
                const progressRef = ref(db, `ntumedsa-quiz-histology-final/${window.currentUserUid}/gameProgress/histology`);
                await set(progressRef, {
                    ...progressData,
                    lastUpdated: Date.now(),
                    timestamp: new Date().toISOString()
                });
                console.log("[saveProgressToFirebase] Progress saved successfully to Firebase");
                return true;
            } catch (error) {
                console.error("[saveProgressToFirebase] Error saving progress to Firebase:", error);
                return false;
            }
        }
        
        async function loadProgressFromFirebase() {
            if (!window.currentUserUid) {
                console.warn("[loadProgressFromFirebase] No user logged in, cannot load progress from Firebase");
                return null;
            }
            
            try {
                const progressRef = ref(db, `ntumedsa-quiz-histology-final/${window.currentUserUid}/gameProgress/histology`);
                const snapshot = await get(progressRef);
                
                if (snapshot.exists()) {
                    const progressData = snapshot.val();
                    console.log("[loadProgressFromFirebase] Progress loaded successfully from Firebase");
                    return progressData;
                } else {
                    console.log("[loadProgressFromFirebase] No progress found in Firebase");
                    return null;
                }
            } catch (error) {
                console.error("[loadProgressFromFirebase] Error loading progress from Firebase:", error);
                return null;
            }
        }
        
        async function removeProgressFromFirebase() {
            if (!window.currentUserUid) {
                console.warn("[removeProgressFromFirebase] No user logged in, cannot remove progress from Firebase");
                return false;
            }
            
            try {
                const progressRef = ref(db, `ntumedsa-quiz-histology-final/${window.currentUserUid}/gameProgress/histology`);
                await set(progressRef, null);
                console.log("[removeProgressFromFirebase] Progress removed successfully from Firebase");
                return true;
            } catch (error) {
                console.error("[removeProgressFromFirebase] Error removing progress from Firebase:", error);
                return false;
            }
        }
        const signInBtn = document.getElementById('signInBtn');
        function setAuthControlsEnabled(enabled) {
            const openDoc = document.getElementById('openDoc');
            if (openDoc) {
                // 不要禁用「題庫」按鈕，讓點擊可顯示「請先登入」提醒
                openDoc.removeAttribute('disabled');
            }
            const resume = document.getElementById('resumeButton');
            if (resume) resume.disabled = !enabled;
            document.querySelectorAll('.dropdown-item, .dropdown-toggle').forEach(el => { el.disabled = !enabled; });
        }
        setAuthControlsEnabled(false);
// 登入模態框控制
const loginModal = document.getElementById('loginModal');
const closeModal = document.getElementById('closeLoginModal');
const loginForm = document.getElementById('loginForm');
const toggleMode = document.getElementById('toggleMode');
const modalTitle = document.getElementById('modalTitle');
const displayNameInput = document.getElementById('displayName');
const submitBtn = document.getElementById('submitBtn');

let isSignUpMode = false;

if (signInBtn) {
    signInBtn.addEventListener('click', async () => {
        // 如果已登入，執行登出
        if (auth.currentUser) {
            try {
                await signOut(auth);
                console.log('登出成功');
                showAlertModal('已成功登出');
            } catch (error) {
                console.error('登出失敗:', error);
                showAlertModal('登出失敗，請稍後再試');
            }
        } else {
            // 如果未登入，顯示登入模態框
            loginModal.style.display = 'flex';
            resetForm();
        }
    });
}

if (closeModal) {
    closeModal.addEventListener('click', () => {
        loginModal.style.display = 'none';
    });
}

if (toggleMode) {
    toggleMode.addEventListener('click', () => {
        isSignUpMode = !isSignUpMode;
        if (isSignUpMode) {
            modalTitle.textContent = '註冊';
            displayNameInput.style.display = 'block';
            displayNameInput.required = true;
            submitBtn.textContent = '註冊';
            toggleMode.textContent = '登入';
            document.querySelector('.login-toggle span').textContent = '已有帳號？';
        } else {
            modalTitle.textContent = '登入';
            displayNameInput.style.display = 'none';
            displayNameInput.required = false;
            submitBtn.textContent = '登入';
            toggleMode.textContent = '註冊';
            document.querySelector('.login-toggle span').textContent = '還沒有帳號？';
        }
        hideForgotPasswordLink();
    });
}

function resetForm() {
    isSignUpMode = false;
    modalTitle.textContent = '登入';
    displayNameInput.style.display = 'none';
    displayNameInput.required = false;
    submitBtn.textContent = '登入';
    toggleMode.textContent = '註冊';
    document.querySelector('.login-toggle span').textContent = '還沒有帳號？';
    loginForm.reset();
    hideForgotPasswordLink();
}

// 點擊模態框外部關閉
window.addEventListener('click', (event) => {
    if (event.target === loginModal) {
        loginModal.style.display = 'none';
    }
});

if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const displayName = document.getElementById('displayName').value;
        
        submitBtn.disabled = true;
        submitBtn.textContent = isSignUpMode ? '註冊中...' : '登入中...';
        
        try {
            if (isSignUpMode) {
                // 註冊新用戶
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 更新用戶顯示名稱
                if (displayName) {
                    await updateProfile(user, {
                        displayName: displayName
                    });
                }
                
                console.log('註冊成功:', user);
                showAlertModal('註冊成功！');
            } else {
                // 登入現有用戶
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('登入成功:', userCredential.user);
                showAlertModal('登入成功！');
            }
            
            loginModal.style.display = 'none';
            resetForm();
            // 登入後刷新排行榜
            try { await fetchLeaderboard(); } catch (e) { console.error('[login] Failed to fetch leaderboard after email login:', e); }
            
        } catch (error) {
            console.error('認證失敗:', error);
            let errorMessage = '發生錯誤，請稍後再試。';
            
            switch (error.code) {
                case 'auth/operation-not-allowed':
                    errorMessage = 'Email/Password 認證尚未啟用。請聯繫管理員。';
                    break;
                case 'auth/email-already-in-use':
                    errorMessage = '此電子郵件已被使用。';
                    break;
                case 'auth/weak-password':
                    errorMessage = '密碼強度不足，至少需要6個字符。';
                    break;
                case 'auth/user-not-found':
                    errorMessage = '找不到此用戶。';
                    break;
                case 'auth/wrong-password':
                    errorMessage = '密碼錯誤。';
                    break;
                case 'auth/invalid-login-credentials':
                    errorMessage = '登入憑證無效。請檢查您的電子郵件和密碼。';
                    break;
                case 'auth/invalid-email':
                    errorMessage = '電子郵件格式無效。';
                    break;
                case 'auth/user-disabled':
                    errorMessage = '此帳戶已被停用。';
                    break;
            }
            
            // 顯示忘記密碼提示的錯誤類型
            const showForgotPasswordErrors = [
                'auth/wrong-password',
                'auth/invalid-login-credentials',
                'auth/email-already-in-use'
            ];
            
            showAlertModal(errorMessage);
            
            if (showForgotPasswordErrors.includes(error.code)) {
                showForgotPasswordLink();
            }
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = isSignUpMode ? '註冊' : '登入';
        }
    });
}

// Google 登入
const googleSignInBtn = document.getElementById('googleSignInBtn');
if (googleSignInBtn) {
    googleSignInBtn.addEventListener('click', async () => {
        try {
            await signInWithPopup(auth, provider);
            showAlertModal('登入成功！');
            loginModal.style.display = 'none';
            resetForm();
            // 登入後刷新排行榜
            try { await fetchLeaderboard(); } catch (e) { console.error('[login] Failed to fetch leaderboard after Google login:', e); }
        } catch (error) {
            console.error('Google 登入失敗:', error);
            let msg = 'Google 登入失敗，請稍後再試。';
            if (error && error.code === 'auth/popup-closed-by-user') {
                msg = '已關閉登入視窗。';
            }
            showAlertModal(msg);
        }
    });
}
        onAuthStateChanged(auth, user => {
            const btn = document.getElementById('signInBtn');
            const greet = document.getElementById('greeting');
            if (user) {
                window.currentUserUid = user.uid;
                // 優先使用暱稱(displayName)，如果沒有則使用email
                const name = user.displayName || user.email;
                if (name) {
                    window.currentPlayer = name;
                    // 登入後按鈕改為「登出」
                    if (btn) {
                        btn.textContent = '登出';
                        btn.style.display = 'flex';
                    }
                    // 問候語顯示在左邊，優先顯示暱稱
                    const displayName = user.displayName || user.email.split('@')[0];
                    if (greet) { 
                        greet.innerHTML = `您好，<span id="greetingName">${displayName}</span><button id="editNicknameBtn" class="edit-nickname-btn" title="編輯暱稱" aria-label="編輯暱稱">✎</button>`; 
                        greet.style.display = 'block'; 
                        const editBtn = document.getElementById('editNicknameBtn');
                        if (editBtn) {
                            editBtn.addEventListener('click', async () => {
                                const currentNameSpan = document.getElementById('greetingName');
                                const currentVal = currentNameSpan ? currentNameSpan.textContent : (user.displayName || user.email.split('@')[0]);
                                if (window.openNicknameModal) {
                                    window.openNicknameModal(currentVal || '');
                                }
                            });
                        }
                    }
                    setAuthControlsEnabled(true);
                    const starTop = document.getElementById('openStarredTop');
                    if (starTop) starTop.style.display = 'flex';
                    // 登入後刷新排行榜
                    try { fetchLeaderboard(); } catch (e) { console.error('[auth] Failed to fetch leaderboard after login:', e); }
                    // Load starred cache for this user
                    loadStarredFromFirebase().then(() => {
                        updateStarButtonState();
                    }).catch(e => console.error('[onAuthStateChanged] Failed to load starred:', e));
                } else {
                    window.currentPlayer = null;
                    if (btn) {
                        btn.textContent = '登入';
                        btn.style.display = 'flex';
                    }
                    if (greet) { greet.textContent = ''; greet.style.display = 'none'; }
                    setAuthControlsEnabled(false);
                    const starTop = document.getElementById('openStarredTop');
                    if (starTop) starTop.style.display = 'none';
                    starredCache = {};
                    updateStarButtonState();
                }
            } else {
                window.currentUserUid = null;
                window.currentPlayer = null;
                if (btn) {
                    btn.textContent = '登入';
                    btn.style.display = 'flex';
                }
                if (greet) { greet.textContent = ''; greet.style.display = 'none'; }
                setAuthControlsEnabled(false);
                const starTop = document.getElementById('openStarredTop');
                if (starTop) starTop.style.display = 'none';
                starredCache = {};
                updateStarButtonState();
            }
            
            // Check for existing progress after auth state is determined
            checkForExistingProgress().catch(error => {
                console.error("[onAuthStateChanged] Error checking for existing progress:", error);
            });
        });
        window.currentPlayer = null; 
        var TIME = 31;
        var numOfProbs;
        var tm;
        var data;
        var x;
        var state = 0;
        var correct = 0;
        var wrong = 0;
        var total = 0;
        var viewing = false;
        var done;
        var score = 0;
        var correctList = [];
        var wrongList = [];
        let questionQueue = [];
        const preloadedImagePaths = new Set();
        const pendingPreloadMap = new Map();
        const PRELOAD_AHEAD_COUNT = 3;
        const lowerCaseSwearWords = [
            "幹", "靠", "操", "媽的", "他媽的", "幹你娘", "機掰", "雞掰", "哭邀", "靠北", "靠腰",
            "操你媽", "王八蛋", "他媽", "賤人", "婊子", "俗辣", "垃圾", "智障", "白痴", "腦殘",
            "低能", "肏", "淦", "靠杯", "三小", "啥小", "死", "屁", "幹您娘", "操機掰", "娘砲", "破麻",
            "操你妈", "干", "他妈", "傻逼", "脑残", "屌",
            "fuck", "fucking", "shit", "bitch", "damn", "asshole", "cunt", "fucker", "motherfucker",
            "dick", "pussy", "wank", "slut", "whore"
        ].map(word => word.toLowerCase());

        const dayNightToggle = document.getElementById('dayNightToggle');
        const dayNightIcon = document.getElementById('dayNightIcon');
        let isDay = true;
        window.gameplayActive = false;

        function renderSun() {
            dayNightIcon.innerHTML = `
                <circle cx="50" cy="50" r="20" class="icon-shape" />
                <g class="sun-rays">
                    ${[...Array(8)].map((_, i) => {
                        const angle = (i * 45) * (Math.PI / 180);
                        const x1 = 50 + Math.cos(angle) * 30;
                        const y1 = 50 + Math.sin(angle) * 30;
                        const x2 = 50 + Math.cos(angle) * 38;
                        const y2 = 50 + Math.sin(angle) * 38;
                        return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="sun-ray" />`;
                    }).join('')}
                </g>
                <g class="moon-group" style="opacity: 0;">
                    <circle cx="50" cy="50" r="20" class="icon-shape" />
                    <circle cx="58" cy="50" r="18" class="moon-mask" />
                </g>
            `;
            dayNightIcon.classList.remove('night');
            dayNightIcon.classList.add('day');
            dayNightIcon.classList.remove('rotate');
        }
        window.init = init;

        function renderMoon() {
            dayNightIcon.innerHTML = `
                 <circle cx="50" cy="50" r="20" class="icon-shape" style="fill: none;"/>
                 <g class="sun-rays" style="opacity: 0;">
                     ${[...Array(8)].map((_, i) => {
                         const angle = (i * 45) * (Math.PI / 180);
                         const x1 = 50 + Math.cos(angle) * 30;
                         const y1 = 50 + Math.sin(angle) * 30;
                         const x2 = 50 + Math.cos(angle) * 38;
                         const y2 = 50 + Math.sin(angle) * 38;
                         return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="sun-ray" />`;
                     }).join('')}
                 </g>
                 <g class="moon-group">
                     <circle cx="50" cy="50" r="20" class="icon-shape" />
                     <circle cx="58" cy="50" r="18" class="moon-mask" />
                 </g>
            `;
            dayNightIcon.classList.remove('day');
            dayNightIcon.classList.add('night');
            dayNightIcon.classList.add('rotate');
        }

        let availableVoices = [];
        function populateVoices() {
            availableVoices = speechSynthesis.getVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => {
                    availableVoices = speechSynthesis.getVoices();
                };
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function resetPreloadState() {
            questionQueue = [];
            preloadedImagePaths.clear();
            pendingPreloadMap.clear();
        }

        function initializeQuestionQueue() {
            questionQueue = [];
            if (!Array.isArray(data) || !Array.isArray(done)) {
                return;
            }
            for (let i = 0; i < data.length; i++) {
                if (!done[i]) {
                    questionQueue.push(i);
                }
            }
            if (questionQueue.length > 1) {
                shuffleArray(questionQueue);
            }
            preloadUpcomingImages();
        }

        function preloadImageAtIndex(index) {
            if (!data || !data[index]) return;
            const path = data[index]?.path;
            if (!path || preloadedImagePaths.has(path) || pendingPreloadMap.has(path)) return;

            const img = new Image();
            img.decoding = 'async';
            if ('loading' in HTMLImageElement.prototype) {
                img.loading = 'eager';
            }

            pendingPreloadMap.set(path, img);
            img.onload = () => {
                preloadedImagePaths.add(path);
                pendingPreloadMap.delete(path);
            };
            img.onerror = (error) => {
                pendingPreloadMap.delete(path);
                console.warn(`[preloadImageAtIndex] Failed to preload image ${path}`, error);
            };
            img.src = path;
        }

        function preloadUpcomingImages() {
            if (!questionQueue.length) return;
            const count = Math.min(PRELOAD_AHEAD_COUNT, questionQueue.length);
            for (let i = 0; i < count; i++) {
                preloadImageAtIndex(questionQueue[i]);
            }
        }

        function addOrUpdateSpeakButton(answerToSpeak, answerDisplayElement) {
            let existingSpeakButton = answerDisplayElement.querySelector('.speak-answer-icon-button');
            if (existingSpeakButton) {
                existingSpeakButton.remove();
            }

            const speakButton = document.createElement('button');
            speakButton.className = 'speak-answer-icon-button';
            speakButton.setAttribute('aria-label', 'Play answer');
            speakButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgb(102, 102, 102)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
            `;
            speakButton.style.background = 'none';
            speakButton.style.border = 'none';
            speakButton.style.padding = '0 0 0 8px';
            speakButton.style.cursor = 'pointer';
            speakButton.style.display = 'inline-flex';
            speakButton.style.alignItems = 'center';
            speakButton.style.verticalAlign = 'middle';


            speakButton.onclick = (event) => {
                event.stopPropagation();
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(answerToSpeak);
                let targetVoice = availableVoices.find(voice => voice.lang.startsWith('en') && (voice.name.toLowerCase().includes('google') || voice.name.toLowerCase().includes('natural')));
                if (!targetVoice) {
                    targetVoice = availableVoices.find(voice => voice.lang.startsWith('en'));
                }
                if (targetVoice) {
                    utterance.voice = targetVoice;
                }
                speechSynthesis.speak(utterance);
            };

            answerDisplayElement.appendChild(speakButton);
        }

        function toggleTheme() {
            isDay = !isDay;
            if (isDay) {
                document.body.classList.remove('dark-mode');
                renderSun();
                dayNightToggle.setAttribute('aria-label', '切換到夜晚模式');
            } else {
                document.body.classList.add('dark-mode');
                renderMoon();
                dayNightToggle.setAttribute('aria-label', '切換到白天模式');
            }
            const bodyStyles = window.getComputedStyle(document.body);
            document.documentElement.style.setProperty('--toggle-moon-mask', bodyStyles.getPropertyValue('--bg-primary'));
        }

        function initDayNightToggle() {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            isDay = !prefersDark;

            if (isDay) {
                renderSun();
                document.body.classList.remove('dark-mode');
                dayNightToggle.setAttribute('aria-label', '切換到夜晚模式');
            } else {
                renderMoon();
                document.body.classList.add('dark-mode');
                dayNightToggle.setAttribute('aria-label', '切換到白天模式');
            }
            const bodyStyles = window.getComputedStyle(document.body);
            document.documentElement.style.setProperty('--toggle-moon-mask', bodyStyles.getPropertyValue('--bg-primary'));

            dayNightToggle.addEventListener('click', toggleTheme);

             window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                isDay = !event.matches;
                 if (isDay) {
                     document.body.classList.remove('dark-mode');
                     renderSun();
                     dayNightToggle.setAttribute('aria-label', '切換到夜晚模式');
                 } else {
                     document.body.classList.add('dark-mode');
                     renderMoon();
                     dayNightToggle.setAttribute('aria-label', '切換到白天模式');
                 }
                 const bodyStyles = window.getComputedStyle(document.body);
                 document.documentElement.style.setProperty('--toggle-moon-mask', bodyStyles.getPropertyValue('--bg-primary'));
             });
        }
        async function writeScore(finalScore) {
            const uid = window.currentUserUid;
            if (!uid) throw new Error("使用者尚未登入");
            
            
            if (!window.currentPlayer || window.currentPlayer.trim() === "") {
                console.error("Player name is not set. Cannot write score to leaderboard.");
                
                showAlertModal("玩家名稱未設定，無法記錄分數。請重新開始並輸入名稱。");
                return score; 
            }

            const scoreRef = ref(db, `ntumedsa-quiz-histology-final/${uid}`);
            try {
                const snap = await get(scoreRef);
                const prev = snap.val();
                const prevScore = prev && typeof prev.score === 'number' ? prev.score : 0;
                const newScore = prevScore + finalScore;
                await update(scoreRef, {
                    name: window.currentPlayer,
                    score: newScore,
                    timestamp: Date.now()
                });
                return newScore;
            } catch (err) {
                console.error("寫入分數失敗：", err);
                throw err;
            }
        }

        async function fetchLeaderboard() {
            const listEl = document.getElementById("boardList");
            listEl.innerHTML = '<li>載入中…</li>';

            try {
                const snap = await get(ref(db, 'ntumedsa-quiz-histology-final'));
                const dataObj = snap.val() || {};
                const entries = Object.entries(dataObj).map(([uid, item]) => ({ uid, ...item }));
                const sorted = entries.sort((a, b) => b.score - a.score);

                listEl.innerHTML = '';
                let inTop = false;
                let prevScore = null;
                let prevRank = 0;
                sorted.forEach((item, index) => {
                    if (index < 10) {
                        const li = document.createElement('li');
                        if (item.uid === window.currentUserUid) li.classList.add('current-user');
                        const rankSpan = document.createElement('span');
                        rankSpan.className = 'leaderboard-rank';
                        let rank;
                        if (item.score === prevScore) {
                            rank = prevRank;
                        } else {
                            rank = index + 1;
                            prevScore = item.score;
                            prevRank = rank;
                        }
                        rankSpan.textContent = rank;
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'leaderboard-name';
                        nameSpan.textContent = item.name;
                        const scoreSpan = document.createElement('span');
                        scoreSpan.className = 'leaderboard-score';
                        scoreSpan.textContent = item.score;
                        li.append(rankSpan, nameSpan, scoreSpan);
                        listEl.appendChild(li);
                        if (item.uid === window.currentUserUid) inTop = true;
                    }
                });
                if (!inTop && window.currentUserUid) { 
                    const userIndex = sorted.findIndex(item => item.uid === window.currentUserUid);
                    if (userIndex !== -1) {
                        const item = sorted[userIndex];
                        const li = document.createElement('li');
                        li.classList.add('current-user');
                        const rankSpan = document.createElement('span');
                        rankSpan.className = 'leaderboard-rank';
                        let userActualRank = 0;
                        let scoreForPrevRank = null;
                        let runningRankForUser = 0;
                        for(let i=0; i < sorted.length; i++) {
                            if (sorted[i].score !== scoreForPrevRank) {
                                runningRankForUser = i + 1;
                                scoreForPrevRank = sorted[i].score;
                            }
                            if (sorted[i].uid === window.currentUserUid) {
                                userActualRank = runningRankForUser;
                                break;
                            }
                        }
                        rankSpan.textContent = userActualRank || (sorted.filter(it => it.score > item.score).length + 1);
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'leaderboard-name';
                        nameSpan.textContent = item.name;
                        const scoreSpan = document.createElement('span');
                        scoreSpan.className = 'leaderboard-score';
                        scoreSpan.textContent = item.score;
                        li.append(rankSpan, nameSpan, scoreSpan);
                        listEl.appendChild(li);
                    }
                }
                const playerData = window.currentUserUid ? sorted.find(item => item.uid === window.currentUserUid) : null;
                const playerScore = playerData ? playerData.score : 0;
                document.getElementById("score-display").textContent = playerScore;
                score = playerScore; 

                const rankDisplay = document.getElementById("rank-display");
                if (rankDisplay) {
                    if (playerData) {
                        let userDisplayRank = "N/A";
                        let currentOverallRank = 0;
                        let scoreForLastOverallRank = null;
                        for (let i = 0; i < sorted.length; i++) {
                            const entry = sorted[i];
                            if (entry.score !== scoreForLastOverallRank) {
                                currentOverallRank = i + 1;
                                scoreForLastOverallRank = entry.score;
                            }
                            if (entry.uid === window.currentUserUid) {
                                userDisplayRank = currentOverallRank;
                                break;
                            }
                        }
                        rankDisplay.textContent = userDisplayRank;
                    } else {
                        rankDisplay.textContent = "N/A";
                    }
                }
            } catch (err) {
                console.error("讀排行榜失敗：", err);
                listEl.innerHTML = '<li>請先登入</li>';
                const rankDisplay = document.getElementById("rank-display");
                if (rankDisplay) rankDisplay.textContent = "N/A";
            }
        }

        function updateCorrect() {
            correct++;
            document.getElementById("correct").innerText = correct;
            const pointsEarned = 2;
            
            if (data && data[x]) {
                correctList.push(data[x]);
            }
            
            writeScore(pointsEarned)
                .then((newTotalScore) => {
                    if (typeof newTotalScore === 'number') score = newTotalScore; 
                    fetchLeaderboard(); 
                    updateScoreDisplay(); 
                })
                .catch(err => console.error("寫入分數或更新排名失敗：", err));
        }
        function updateWrong() {
            wrong++;
            document.getElementById("wrong").innerText = wrong;
            const pointsLost = -2;
            
            if (data && data[x]) {
                wrongList.push(data[x]);
            }
            
            writeScore(pointsLost)
                .then((newTotalScore) => {
                    if (typeof newTotalScore === 'number') score = newTotalScore;
                    fetchLeaderboard();
                    updateScoreDisplay();
                })
                .catch(err => console.error("寫入分數或更新排名失敗：", err));
        }
        function updateUnknown(){
            wrong++;
            document.getElementById("wrong").innerText = wrong;
            const pointsLost = -1;
            
            if (data && data[x]) {
                wrongList.push(data[x]);
            }
            
            writeScore(pointsLost)
                .then((newTotalScore) => {
                    if (typeof newTotalScore === 'number') score = newTotalScore;
                    fetchLeaderboard();
                    updateScoreDisplay();
                })
                .catch(err => console.error("寫入分數或更新排名失敗：", err));
        }

        function handleEndOfRound() {
            const nextBtn = document.getElementById('next');
            const cardAnswerDiv = document.querySelector(".card-answer");

            cardAnswerDiv.style.display = "flex"; 
            document.querySelector('.answer-input-container').style.visibility = 'hidden';
            document.querySelector('.bottom-buttons').style.visibility = 'hidden';
            document.querySelector('.your-answer-label').style.visibility = 'hidden';
            nextBtn.style.display = 'block'; 

            if (wrongList.length > 0) {
                nextBtn.innerText = "重玩錯誤";
                nextBtn.removeEventListener('click', nextProb);
                nextBtn.addEventListener('click', startReviewWrong);
                showAlertModal(`本回合錯誤 ${wrongList.length} 題。點擊「重玩錯誤」再次挑戰！`);
            } else {
                showAlertModal(`恭喜你全部答對！最終分數：${score} 🎉`);
                nextBtn.style.display = 'none';
                if (window.currentUserUid) { removeProgressFromFirebase().catch(e => console.warn('[endRound] Unable to clear Firebase progress:', e)); }
                window.gameplayActive = false;

                
                document.removeEventListener("keydown", enterKeyEvent);
                const submitBtnEl = document.getElementById("submitAnswer");
                if (submitBtnEl) submitBtnEl.removeEventListener("click", submitUserAnswer);
                const dontKnowBtnEl = document.getElementById("dontKnow");
                if (dontKnowBtnEl) dontKnowBtnEl.removeEventListener("click", showAnswer);
                const correctAreaEl = document.getElementById("correctArea");
                if (correctAreaEl) correctAreaEl.removeEventListener("click", showCorrectList);
                const wrongAreaEl = document.getElementById("wrongArea");
                if (wrongAreaEl) wrongAreaEl.removeEventListener("click", showWrongList);
                if (nextBtn) nextBtn.removeEventListener('click', nextProb); 

                setTimeout(() => {
                    document.querySelector('.flashcard-container').style.display = 'none';
                    document.querySelector('.start-screen').style.display = 'flex';
                    const resumeButtonEl = document.getElementById('resumeButton');
                    const progressActionsEl = document.querySelector('.progress-actions');
                    const startButtonsEl = document.querySelector('.start-buttons');
                    if(resumeButtonEl) resumeButtonEl.style.display = 'none';
                    if(progressActionsEl) progressActionsEl.style.display = 'none';
                    if(startButtonsEl) startButtonsEl.style.display = 'flex';
                    fetchLeaderboard();
                }, 3000);
            }
        }

        function startReviewWrong() {
            console.log("[startReviewWrong] Starting review of wrong answers.");
            if (wrongList.length === 0) {
                console.warn("[startReviewWrong] No wrong answers to review.");
                handleEndOfRound(); 
                return;
            }

            data = [...wrongList]; 
            numOfProbs = data.length;

            wrongList = [];
            correctList = []; 
            correct = 0;
            wrong = 0;
            
            document.getElementById("correct").innerText = correct;
            document.getElementById("wrong").innerText = wrong;
            

            done = new Array(numOfProbs).fill(false);
            resetPreloadState();
            initializeQuestionQueue();
            x = -1;

            const nextBtn = document.getElementById('next');
            nextBtn.innerText = "下一個";
            nextBtn.removeEventListener('click', startReviewWrong);
            nextBtn.addEventListener('click', nextProb);

            document.querySelector('.card-answer').style.display = 'none';
            document.querySelector('.answer-input-container').style.visibility = 'visible';
            document.querySelector('.bottom-buttons').style.visibility = 'visible';
            document.querySelector('.your-answer-label').style.visibility = 'visible';
            viewing = false;

            nextProb(); 
        }


        function init() {
            console.log("[init] Initializing application.");
            initDayNightToggle();
            populateVoices();

            

            fetchLeaderboard();
            const leaderboardEl = document.querySelector('.leaderboard');
            
            
            
            
            
            

            document.addEventListener("keydown", function(e) {
                if (window.isComposing) return;

                if (e.key === "/") {
                    const answerInput = document.getElementById("answer");
                    const playerNameInput = document.getElementById("signInBtn");
                    const explanationContribInput = document.getElementById('explanation-input');

                    const flashcardContainer = document.querySelector('.flashcard-container');
                    const isGameActive = flashcardContainer && getComputedStyle(flashcardContainer).display !== 'none';

                    let focused = false;
                    if (isGameActive) {
                        if (answerInput && document.activeElement !== answerInput &&
                            (!explanationContribInput || document.activeElement !== explanationContribInput)) {
                            answerInput.focus();
                            focused = true;
                        }
                    } else {
                        const startScreen = document.querySelector('.start-screen');
                        const isStartScreenActive = startScreen && getComputedStyle(startScreen).display !== 'none';
                        if (isStartScreenActive && playerNameInput && document.activeElement !== playerNameInput) {
                             playerNameInput.focus();
                             focused = true;
                        }
                    }

                    if (focused) {
                        e.preventDefault();
                    }
                }
            });

            function createStartHandler(jsonPath) {
                return async function () {
                    console.log(`[createStartHandler] Starting game with ${jsonPath}`);
                    
                    if (!auth.currentUser) {
                        showAlertModal("請先登入！");
                        window.gameplayActive = false;
                        return;
                    }
                    window.currentPlayer = (auth.currentUser.displayName || auth.currentUser.email || "使用者");
                    window.gameplayActive = true;
                    console.log("[createStartHandler] Set window.gameplayActive to true");

                    document.querySelector('.start-screen').style.display = 'none'; 
                    document.querySelector('.flashcard-container').style.display = 'flex';

                    state = 1;
                    correct = 0; wrong = 0; total = 0; 
                    console.log("[createStartHandler] Resetting scores and lists. Correct:", correct, "Wrong:", wrong);
                    document.getElementById("correct").innerHTML = correct;
                    document.getElementById("wrong").innerHTML = wrong;
                    updateScoreDisplay();
                    correctList = []; wrongList = [];
                    console.log("[createStartHandler] Cleared correctList:", JSON.parse(JSON.stringify(correctList)), "wrongList:", JSON.parse(JSON.stringify(wrongList)));

                    const nextBtn = document.getElementById('next');
                    nextBtn.innerText = "下一個";
                    nextBtn.removeEventListener('click', startReviewWrong); 
                    nextBtn.addEventListener('click', nextProb); 

                    // remember current unit info for resume label
                    try {
                        const clickedItem = Array.from(document.querySelectorAll('.dropdown-item'))
                          .find(el => el.dataset.json === jsonPath);
                        if (clickedItem) {
                            window.currentUnitName = clickedItem.textContent.trim();
                        } else {
                            window.currentUnitName = jsonPath.split('/')?.pop()?.replace(/\.json$/,'') || '單元';
                        }
                        window.currentJsonPath = jsonPath;
                    } catch (_) {
                        window.currentUnitName = '單元';
                        window.currentJsonPath = jsonPath;
                    }

                    $.getJSON(jsonPath)
                        .done(function (jsonData) {
                            try {
                                data = jsonData;
                                numOfProbs = data.length;
                                if (numOfProbs === 0) throw new Error("No data loaded from JSON.");
                                data = parseMultiAns(data);
                                done = new Array(numOfProbs).fill(false);
                                resetPreloadState();
                                initializeQuestionQueue();
                                console.log("[createStartHandler] Data loaded. numOfProbs:", numOfProbs, "Initial done array:", JSON.parse(JSON.stringify(done)));
                                startGame();
                            } catch (error) {
                                console.error("Error processing JSON data:", error);
                                showAlertModal("Failed to load or process game data.");
                                window.gameplayActive = false;
                            }
                        })
                        .fail(function (jqXHR, textStatus, errorThrown) {
                            console.error("Failed to load JSON:", textStatus, errorThrown);
                            showAlertModal("無法讀取遊戲資料");
                            window.gameplayActive = false;
                        });
                };
            }



            const dropdownItems = document.querySelectorAll(".dropdown-item");
            dropdownItems.forEach(item => {
                item.addEventListener("click", function() {
                    const jsonPath = this.dataset.json;
                    const dropdownMenuElement = this.closest('.dropdown-menu');
                    const isTikuDropdown = dropdownMenuElement.querySelector('#openDoc') !== null;

                    if (isTikuDropdown) {
                        // Handle 題庫 dropdown - open question bank for specific JSON
                        openTikuHandler(`${jsonPath}`)();
                    } else {
                        // Handle 單元 dropdown - start game with specific JSON
                        createStartHandler(`${jsonPath}`)();
                    }

                    if (dropdownMenuElement && dropdownMenuElement.classList.contains('active')) {
                        dropdownMenuElement.classList.remove('active');
                    }
                });
            });

            const dropdownMenuToggles = document.querySelectorAll('.dropdown-toggle');
            const dropdownMenuElements = document.querySelectorAll('.dropdown-menu');

            dropdownMenuToggles.forEach((toggle, index) => {
                const menuElement = dropdownMenuElements[index];
                if (toggle && menuElement) {
                    toggle.addEventListener('click', function(event) {
                        if (window.matchMedia("(pointer: coarse)").matches) {
                            menuElement.classList.toggle('active');
                            event.stopPropagation();
                        }
                    });
                }
            });

            document.addEventListener('click', function(event) {
                dropdownMenuElements.forEach(menuElement => {
                    if (menuElement.classList.contains('active') &&
                        !menuElement.contains(event.target)) {
                        menuElement.classList.remove('active');
                    }
                });
            });



            adjustPlaceholder();
            window.addEventListener('resize', adjustPlaceholder);

            function populateImageModal(item) {
                if (!item) return;
                const modalImage = document.getElementById('modalImage');
                if (modalImage) {
                    modalImage.src = item.path || '';
                    modalImage.alt = item.answer?.[0] || 'Image preview';
                    if ('fetchPriority' in modalImage) {
                        modalImage.fetchPriority = 'high';
                    }
                }
                const modalAnswer = document.getElementById('modalAnswer');
                if (modalAnswer) {
                    modalAnswer.textContent = Array.isArray(item.answer) ? item.answer.join(' / ') : '';
                }
                const modalExplanation = document.getElementById('modalExplanation');
                if (modalExplanation) {
                    modalExplanation.textContent = item.explanation || '';
                }
                const modalNumber = document.getElementById('modalNumber');
                if (modalNumber) {
                    const errataValue = item.num !== undefined && item.num !== null && String(item.num).trim() !== ''
                        ? String(item.num)
                        : 'N/A';
                    modalNumber.textContent = `勘誤編號：${errataValue}`;
                }
            }

            async function loadSpecificJsonData(jsonPath) {
                try {
                    const response = await $.getJSON(jsonPath);
                    return Array.isArray(response) ? response : [];
                } catch (error) {
                    console.warn(`[loadSpecificJsonData] Failed to load ${jsonPath}:`, error);
                    return [];
                }
            }

            window.openTikuHandler = function(jsonPath) {
                return async function() {
                    if (!auth.currentUser) {
                        showAlertModal('請先登入');
                        return;
                    }
                    const container = document.getElementById("docContainer");
                    const content = document.getElementById("docContent");
                    container.style.display = 'block';
                    content.innerHTML = '<p>載入中...</p>';

                    try {
                        const dataArr = await loadSpecificJsonData(jsonPath);
                        window.docData = dataArr;
                        content.innerHTML = '';
                        dataArr.forEach(item => {
                          const entry = document.createElement('div');
                          entry.className = 'doc-entry';
                          if (item.path) {
                            const img = document.createElement('img');
                            img.src = item.path;
                            img.alt = item.answer[0] || '';
                            img.loading = 'lazy';
                            img.decoding = 'async';
                            if ('fetchPriority' in img) {
                                img.fetchPriority = 'low';
                            }
                            entry.appendChild(img);
                            img.style.cursor = 'pointer';
                            img.addEventListener('click', () => {
                              populateImageModal(item);
                              document.getElementById('imageModal').style.display = 'flex';
                              document.getElementById('imageModal').style.opacity = '1';
                              window.modalIndex = dataArr.indexOf(item);
                            });
                          }
                          const textWrapper = document.createElement('div');
                          textWrapper.className = 'doc-text';
                          if (item.description) {
                            const desc = document.createElement('p');
                            desc.innerHTML = `<em>${escapeHtml(item.description)}</em>`;
                            textWrapper.appendChild(desc);
                          }
                          const ans = document.createElement('p');
                          const answerContent = Array.isArray(item.answer) ? item.answer.join(' / ') : '';
                          ans.innerHTML = `<strong>${escapeHtml(answerContent)}</strong>`;
                          textWrapper.appendChild(ans);
                          if (item.explanation) {
                            const pre = document.createElement('pre');
                            pre.textContent = item.explanation;
                            textWrapper.appendChild(pre);
                          }
                          const errata = document.createElement('p');
                          errata.className = 'errata-number';
                          const errataValue = item.num !== undefined && item.num !== null && String(item.num).trim() !== ''
                            ? String(item.num)
                            : 'N/A';
                          errata.textContent = `勘誤編號：${errataValue}`;
                          textWrapper.appendChild(errata);
                          entry.appendChild(textWrapper);
                          content.appendChild(entry);
                        });
                    } catch (err) {
                        console.error('[openTikuHandler] Failed to load data for doc view:', err);
                        content.innerHTML = '<p>讀取資料失敗</p>';
                    }
                };
            };

            // Keep the old openDoc handler for backward compatibility (though it won't be used anymore)
            document.getElementById("openDoc").addEventListener("click", async function() {
                if (!auth.currentUser) {
                    showAlertModal('請先登入');
                    return;
                }
                showAlertModal('請從下拉選單中選擇要查看的題庫');
            });
            document.getElementById('closeImageModal').addEventListener('click', () => {
              document.getElementById('imageModal').style.display = 'none';
            });
            const prevBtn = document.getElementById('prevImageButton');
            const nextBtn = document.getElementById('nextImageButton');
            prevBtn.addEventListener('click', () => {
                if (window.docData) {
                    window.modalIndex = (window.modalIndex - 1 + window.docData.length) % window.docData.length;
                    const it = window.docData[window.modalIndex];
                    populateImageModal(it);
                }
            });
            nextBtn.addEventListener('click', () => {
                if (window.docData) {
                    window.modalIndex = (window.modalIndex + 1) % window.docData.length;
                    const it = window.docData[window.modalIndex];
                    populateImageModal(it);
                }
            });
            document.getElementById("closeDoc").addEventListener("click", function() {
                document.getElementById("docContainer").style.display = 'none';
            });

            document.addEventListener("DOMContentLoaded", function () {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                const link = document.querySelector('a[href="profile.mobileconfig"]');
                const downloadBlock = document.getElementById("download-block");

                if (/android/i.test(userAgent)) {
                    link.textContent = "安卓下載";
                    link.setAttribute("href", "parasite_game_v1.apk");
                    link.setAttribute("download", "Parasite.apk");
                } else if (/iPad|iPhone|iPod/.test(userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {
                    link.textContent = "蘋果下載";
                    link.setAttribute("href", "profile.mobileconfig");
                    link.setAttribute("download", "Parasite.mobileconfig");
                } else {
                    if (downloadBlock) downloadBlock.style.display = "none";
                }
            });
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const link = document.querySelector('a[href="profile.mobileconfig"]');
            const downloadBlock = document.getElementById("download-block");

            if (/android/i.test(userAgent)) {
                if(link) {
                    link.textContent = "安卓下載";
                    link.setAttribute("href", "parasite_game_v1.apk");
                    link.setAttribute("download", "Parasite.apk");
                }
            } else if (/iPad|iPhone|iPod/.test(userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {
                if(link) {
                    link.textContent = "蘋果下載";
                    link.setAttribute("href", "profile.mobileconfig");
                    link.setAttribute("download", "Parasite.mobileconfig");
                }
            } else {
                if (downloadBlock) downloadBlock.style.display = "none";
            }

            const resumeBtn = document.getElementById('resumeButton');
            const restartProgress = document.getElementById('restartProgress');
            if (resumeBtn) {
              resumeBtn.addEventListener('click', async () => {
                console.log("[resumeButton] Clicked. Attempting to resume progress.");
                
                if (!auth.currentUser) {
                    showAlertModal("請先登入才能接續遊戲！");
                    return;
                }
                window.currentPlayer = (auth.currentUser.displayName || auth.currentUser.email || "使用者"); 

                window.gameplayActive = true;
                console.log("[resumeButton] Set window.gameplayActive to true");

                document.querySelector('.start-screen').style.display = 'none';
                console.log("[resumeButton] Set start-screen display to 'none'.");
                document.querySelector('.progress-actions').style.display = 'block';
                document.querySelector('.start-buttons').style.display = 'none';

                // Load progress from Firebase (Firebase only)
                let prog = null;
                
                if (window.currentUserUid) {
                    try {
                        prog = await loadProgressFromFirebase();
                        if (prog) {
                            console.log("[resumeButton] Loaded progress from Firebase:", JSON.parse(JSON.stringify(prog)));
                        }
                    } catch (error) {
                        console.error("[resumeButton] Error loading progress from Firebase:", error);
                    }
                }

                if (!prog) {
                    console.warn("[resumeButton] No progress found in Firebase or localStorage.");
                    window.gameplayActive = false;
                    document.getElementById('resumeButton').style.display = 'none';
                    document.querySelector('.progress-actions').style.display = 'none';
                    document.querySelector('.start-buttons').style.display = 'flex';
                    document.querySelector('.start-screen').style.display = 'flex';
                    return;
                }

                // Validate progress data
                if (!prog || typeof prog !== 'object') {
                    console.error("[resumeButton] Invalid progress data format");
                    showAlertModal('進度讀取失敗，已清除損壞的進度，請重新開始。');
                    window.gameplayActive = false;
                    document.getElementById('resumeButton').style.display = 'none';
                    document.querySelector('.progress-actions').style.display = 'none';
                    document.querySelector('.start-buttons').style.display = 'flex';
                    document.querySelector('.flashcard-container').style.display = 'none';
                    document.querySelector('.start-screen').style.display = 'flex';
                    
                    // Clear Firebase
                    if (window.currentUserUid) {
                        removeProgressFromFirebase();
                    }
                    return;
                }

                data = Array.isArray(prog.data) ? prog.data : [];
                 console.log("[resumeButton] Loaded data from progress. Length:", data.length);
                if (data.length === 0) {
                    console.error("Resumed data is empty. Clearing progress.");
                    // Clear Firebase
                    if (window.currentUserUid) {
                        removeProgressFromFirebase();
                    }
                    window.gameplayActive = false;
                    document.getElementById('resumeButton').style.display = 'none';
                    document.querySelector('.progress-actions').style.display = 'none';
                    document.querySelector('.start-buttons').style.display = 'flex';
                    document.querySelector('.flashcard-container').style.display = 'none';
                    document.querySelector('.start-screen').style.display = 'flex';
                    showAlertModal('進度讀取錯誤（無題目資料），已清除舊進度，請重新開始。');
                    return;
                }
                numOfProbs = data.length;

                x = Number(prog.x) || 0;
                if (x < 0 || x >= numOfProbs) {
                    console.warn(`[resumeButton] Resumed question index ${prog.x} is out of bounds for ${numOfProbs} questions. Resetting to 0.`);
                    x = 0;
                }
                 console.log("[resumeButton] Current question index x:", x);

                done = (Array.isArray(prog.done) && prog.done.length === numOfProbs) ? prog.done : new Array(numOfProbs).fill(false);
                 console.log("[resumeButton] Loaded 'done' array:", JSON.parse(JSON.stringify(done)));

                // restore unit info if available
                if (prog.unitName) { window.currentUnitName = prog.unitName; }
                if (prog.jsonPath) { window.currentJsonPath = prog.jsonPath; }

                // update resume label and progress in case UI is visible
                try {
                    const unitNameText = (prog.unitName || window.currentUnitName || '單元');
                    const total = Array.isArray(prog.data) ? prog.data.length : 0;
                    const completed = Array.isArray(prog.done) ? prog.done.filter(Boolean).length : 0;
                    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
                    const resumeEl = document.getElementById('resumeButton');
                    if (resumeEl) resumeEl.textContent = `繼續 ${unitNameText}`;
                    const resumeProgress = document.getElementById('resumeProgress');
                    const fill = document.getElementById('resumeProgressFill');
                    const text = document.getElementById('resumeProgressText');
                    if (resumeProgress && fill && text) {
                        resumeProgress.style.display = 'flex';
                        fill.style.width = `${percent}%`;
                        text.textContent = `已完成 ${percent}%`;
                    }
                } catch (e) { }

                resetPreloadState();
                initializeQuestionQueue();

                correct = Number(prog.correct) || 0;
                wrong = Number(prog.wrong) || 0;
                
                
                
                if (typeof prog.score === 'number') {
                    score = prog.score; 
                }

                correctList = Array.isArray(prog.correctList) ? prog.correctList : [];
                wrongList = Array.isArray(prog.wrongList) ? prog.wrongList : [];
                 console.log("[resumeButton] Loaded scores and lists. Correct:", correct, "Wrong:", wrong);
                 console.log("[resumeButton] correctList:", JSON.parse(JSON.stringify(correctList)));
                 console.log("[resumeButton] wrongList:", JSON.parse(JSON.stringify(wrongList)));


                updateScoreDisplay(); 
                fetchLeaderboard().catch(err => console.error("[resumeButton] Failed to fetch leaderboard on resume:", err)); 

                document.querySelector('.start-screen').style.display = 'none';
                document.querySelector('.flashcard-container').style.display = 'flex';

                console.log("[resumeButton] Adding event listeners for game interactions.");
                document.addEventListener("keydown", enterKeyEvent);
                document.getElementById("submitAnswer").addEventListener("click", submitUserAnswer);
                document.getElementById("dontKnow").addEventListener("click", showAnswer);
                document.getElementById("correctArea").addEventListener("click", showCorrectList);
                document.getElementById("wrongArea").addEventListener("click", showWrongList);
                
                const nextButton = document.getElementById("next");
                nextButton.removeEventListener('click', startReviewWrong); 
                nextButton.addEventListener("click", nextProb); 

                document.getElementById('closeModal').addEventListener('click', function() {
                    document.getElementById('modal').style.display = "none";
                });

                updateImage(true); 

                if (done.every(d => d)) {
                    handleEndOfRound();
                } else {
                    viewing = true;
                    console.log("[resumeButton] Setting viewing to true. UI elements for answering will be hidden.");
                    document.querySelector('.answer-input-container').style.visibility = 'hidden';
                    document.querySelector('.bottom-buttons').style.visibility = 'hidden';
                    document.querySelector('.your-answer-label').style.visibility = 'hidden';

                    const cardAnswerDiv = document.querySelector(".card-answer");
                    cardAnswerDiv.style.display = "flex";
                    nextButton.style.display = 'block'; 

                    const showAnsDiv = document.getElementById("showAnswer");
                    if (data[x] && data[x].answer) {
                         showAnsDiv.innerHTML = `<strong style="color: #F59E0B;">答案：</strong>${data[x].answer.join(' / ')}`;
                         console.log("[resumeButton] Displaying answer for resumed question:", data[x].answer.join(' / '));
                         if (data[x].answer.length > 0 && data[x].answer[0]) {
                            addOrUpdateSpeakButton(data[x].answer[0], showAnsDiv);
                         }
                    } else {
                        showAnsDiv.innerHTML = "答案資訊錯誤";
                        console.warn(`[resumeButton] No answer found for restored question index ${x}. data[x]:`, data[x]);
                    }
                    showExplanation(); 

                    const answerInput = document.getElementById("answer");
                    const desc = data[x]?.description;
                    if (desc && desc.trim() !== "") {
                        answerInput.placeholder = desc;
                    } else {
                        adjustPlaceholder();
                    }
                }
                window.preloadNextImage();
                console.log("[resumeButton] Resume process finished.");
              });
            }
            if (restartProgress) {
              restartProgress.addEventListener('click', async () => {
                console.log("[restartProgress] Clicked. Clearing game progress from Firebase.");
                window.gameplayActive = false;
                console.log("[restartProgress] Set window.gameplayActive to false");
                
                // Clear progress from Firebase only
                if (window.currentUserUid) {
                    const success = await removeProgressFromFirebase();
                    if (success) {
                        console.log("[restartProgress] Successfully cleared progress from Firebase");
                    } else {
                        console.warn("[restartProgress] Failed to clear progress from Firebase, but continuing...");
                    }
                }
                showAlertModal('進度已清除');

                document.querySelector('.flashcard-container').style.display = 'none';
                document.querySelector('.start-screen').style.display = 'flex';

                document.getElementById('resumeButton').style.display = 'none';
                document.querySelector('.progress-actions').style.display = 'none';
                document.querySelector('.start-buttons').style.display = 'flex';

                console.log("[restartProgress] Resetting in-memory scores and lists before restart.");
                correct = 0;
                wrong = 0;
                correctList = [];
                wrongList = [];
                done = [];
                x = -1;
                resetPreloadState();
                
                
                
                console.log("[restartProgress] Cleared correctList:", JSON.parse(JSON.stringify(correctList)), "wrongList:", JSON.parse(JSON.stringify(wrongList)));

                document.getElementById("correct").innerText = correct;
                document.getElementById("wrong").innerText = wrong;
                updateScoreDisplay(); 

                const imageElement = document.getElementById("image");
                if (imageElement) {
                    imageElement.src = "";
                    imageElement.alt = "Parasite Image";
                    imageElement.classList.remove('loaded');
                }
                const loadingScreen = document.querySelector('.loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none'; 
                }
                const answerInput = document.getElementById("answer");
                if (answerInput) {
                    answerInput.value = "";
                }
                const showAnswerDiv = document.getElementById("showAnswer");
                if (showAnswerDiv) {
                    showAnswerDiv.innerHTML = "";
                }
                const showExplanationDiv = document.getElementById("showExplanation");
                if (showExplanationDiv) {
                    showExplanationDiv.innerHTML = "";
                    showExplanationDiv.style.display = "none";
                }
                const cardAnswerOverlay = document.querySelector(".card-answer");
                if (cardAnswerOverlay) {
                    cardAnswerOverlay.style.display = "none";
                }
                adjustPlaceholder();
                console.log("[restartProgress] UI reset complete.");
              });
            }
        }

        function sendToGoogleDocs(content) {
            const url = 'https://script.google.com/macros/s/AKfycbzWbgs69CkM1nsQKCdtSp26b0LKmCqpzqlAnuetqzgqfd3KVkcZSjWB19vmNhcvlXeO/exec';
            const submitButton = document.getElementById('submit-explanation-button');

            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', },
                body: new URLSearchParams({ content: content })
            })
            .then(() => { console.log("Data likely sent successfully (no-cors mode)."); })
            .catch(error => {
                console.error('Error sending data:', error);
                showAlertModal('送出詳解時發生錯誤，請稍後再試。');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('loading');
                }
                return;
            })
            setTimeout(hideContributionInput, 300);
        }

        function parseMultiAns(data) {
            if (!data) return [];
            Object.values(data).forEach(item => {
                if (item && typeof item.answer === 'string') {
                    item.answer = item.answer.split(" / ").map(s => s.trim()).filter(s => s);
                } else if (!item || typeof item.answer === 'undefined') {
                    item.answer = [];
                }
            });
            return data;
        }
        function enterKeyEvent(event) {
            if (isComposing) return;
            if (event.key === 'Enter') {
                const explanationInput = document.getElementById('explanation-input');
                if (explanationInput && document.activeElement === explanationInput && explanationInput.offsetParent !== null) {
                    event.preventDefault();
                    submitContribution();
                } else if (!viewing && document.getElementById("answer").value.trim() !== "") {
                    submitUserAnswer();
                } else if (viewing && document.querySelector('.card-answer').style.display === 'flex') {
                    const nextBtn = document.getElementById('next');
                    if (nextBtn && nextBtn.style.display !== 'none') {
                         nextBtn.click(); 
                    }
                }
            }
        }
        function startGame() {
            console.log("[startGame] Called. Setting up game event listeners.");
            document.addEventListener("keydown", enterKeyEvent);
            document.getElementById("submitAnswer").addEventListener("click", submitUserAnswer);
            document.getElementById("dontKnow").addEventListener("click", showAnswer);
            document.getElementById("correctArea").addEventListener("click", showCorrectList);
            document.getElementById("wrongArea").addEventListener("click", showWrongList);
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('modal').style.display = "none";
            });

            window.addEventListener('click', function(event) {
                let regularModal = document.getElementById('modal');
                if (event.target === regularModal) {
                    regularModal.style.display = "none";
                }
            });

            nextProb();
            try { updateStarButtonState(); } catch (e) {}
            console.log("[startGame] Finished. Called nextProb().");
        }
        function checkAns(input, ansArr) {
            if (!Array.isArray(ansArr)) return false;
            const normalizedInput = input.replace(/[\p{P}\s]/gu, "").toLowerCase();
            return ansArr.some(ans => ans.replace(/[\p{P}\s]/gu, "").toLowerCase() === normalizedInput);
        }
        function submitUserAnswer() {
            console.log("[submitUserAnswer] Called. viewing:", viewing, "isComposing:", isComposing);
            if (isComposing) {
                console.log("[submitUserAnswer] Bailed: isComposing is true.");
                return;
            }
            var userAnswerRaw = document.getElementById("answer").value;
            var lowerUserAnswer = userAnswerRaw.replace(/[\p{P}\s]/gu, "").toLowerCase();
            console.log("[submitUserAnswer] User answer (raw):", userAnswerRaw, "(lower):", lowerUserAnswer);


            if (lowerUserAnswer && lowerCaseSwearWords.some(swearWord => lowerUserAnswer.includes(swearWord))) {
                window.open('https://youtu.be/HmIMmFAV4BY', '_blank');
                document.getElementById("answer").value = "";
                console.log("[submitUserAnswer] Swear word detected. Bailing.");
                return;
            }

            if (viewing) {
                 console.log("[submitUserAnswer] Bailed: viewing is true.");
                return;
            }
            clearTimeout(tm);

            var userAnswer = userAnswerRaw;
            if (userAnswer.replace(/[\p{P}\s]/gu, "") === "") return;

            viewing = true;
            document.querySelector('.answer-input-container').style.visibility = 'hidden';
            document.querySelector('.bottom-buttons').style.visibility = 'hidden';
            document.querySelector('.your-answer-label').style.visibility = 'hidden';

            var showAnsDiv = document.getElementById("showAnswer");
            var cardAnswerDiv = document.querySelector(".card-answer");
            cardAnswerDiv.style.display = "flex";

            if (checkAns(userAnswer, data[x].answer)) {
                showAnsDiv.innerHTML = `<strong style="color: #10B981;">對了欸！！🥹</strong> 答案是：${data[x].answer.join(' / ')}`;
                if (data[x].answer && data[x].answer.length > 0) {
                    const primaryAnswerToSpeak = data[x].answer[0];
                    if (primaryAnswerToSpeak) {
                        addOrUpdateSpeakButton(primaryAnswerToSpeak, showAnsDiv);
                    }
                }
                showExplanation();
                updateCorrect();
            } else {
                showAnsDiv.innerHTML = `<strong style="color: #EF4444;">錯了錯了😭</strong> 正確答案是：${data[x].answer.join(' / ')}`;
                if (data[x].answer && data[x].answer.length > 0) {
                    const primaryAnswerToSpeak = data[x].answer[0];
                    if (primaryAnswerToSpeak) {
                        addOrUpdateSpeakButton(primaryAnswerToSpeak, showAnsDiv);
                    }
                }
                showExplanation();
                updateWrong();
            }

            total++;
        }
        function hideExplanation() {
            const expDiv = document.getElementById("showExplanation");
            expDiv.innerHTML = "";
            expDiv.style.display = "none";
        }
        function showAnswer() {
            console.log("[showAnswer] Called (Don't Know). viewing:", viewing);
            if (viewing) {
                console.log("[showAnswer] Bailed: viewing is true.");
                return;
            }
            clearTimeout(tm);
            console.log("[showAnswer] Current question item (data[x]):", JSON.parse(JSON.stringify(data[x])));
            console.log("[showAnswer] correctList before update:", JSON.parse(JSON.stringify(correctList)));
            console.log("[showAnswer] wrongList before update:", JSON.parse(JSON.stringify(wrongList)));

            viewing = true;
            document.querySelector('.answer-input-container').style.visibility = 'hidden';
            document.querySelector('.bottom-buttons').style.visibility = 'hidden';
            document.querySelector('.your-answer-label').style.visibility = 'hidden';

            var showAnsDiv = document.getElementById("showAnswer");
            var cardAnswerDiv = document.querySelector(".card-answer");
            cardAnswerDiv.style.display = "flex";

            showAnsDiv.innerHTML = `<strong style="color: #F59E0B;">答案：</strong>${data[x].answer.join(' / ')}`;
            if (data[x].answer && data[x].answer.length > 0) {
                const primaryAnswerToSpeak = data[x].answer[0];
                 if (primaryAnswerToSpeak) {
                    addOrUpdateSpeakButton(primaryAnswerToSpeak, showAnsDiv);
                }
            }
            showExplanation();
            updateUnknown();
            console.log("[showAnswer] correctList after update:", JSON.parse(JSON.stringify(correctList)));
            console.log("[showAnswer] wrongList after update:", JSON.parse(JSON.stringify(wrongList)));

            total++;
             console.log("[showAnswer] Exiting. total:", total, "viewing:", viewing);
        }
        function showExplanation() {
             var expDiv = document.getElementById("showExplanation");
            expDiv.innerHTML = '';
            const explanationText = data[x]?.explanation?.trim();
            const hasExplanation = explanationText && explanationText !== "\"\"" && explanationText !== "\"\"";

            if (hasExplanation) {
                const sanitizedExplanation = explanationText.replace(/<script.*?>.*?<\/script>/gi, '');
                expDiv.innerHTML = `<strong>偷偷告訴你為什麼：</strong>${sanitizedExplanation}`;
            } else {
                expDiv.innerHTML = `
                    <div id="no-explanation-message" style="position: relative; display: inline-block;">
                        <i>這題還沒有詳解⋯不過你可以</i>
                        <span class="contribute-link" onclick="showContributionInput()">貢獻一下！</span>
                        <div class="tooltip">
                            提交詳解可獲得 10分，但亂填會被清除所有分數
                            <div class="tooltip-arrow"></div>
                        </div>
                    </div>
                    <div class="contribution-area" id="contribution-area" style="display: none;">
                        <input id="explanation-input" placeholder="請輸入你的詳解⋯"></input>
                        <button id="submit-explanation-button" onclick="submitContribution()">送出</button>
                    </div>
                `;
            }
            
            
            const errorNum = data[x]?.num;
            const cardAnswerDiv = document.querySelector(".card-answer");
            
            
            const existingErrorNum = cardAnswerDiv.querySelector('.error-number');
            if (existingErrorNum) {
                existingErrorNum.remove();
            }
            
            
            if (errorNum && cardAnswerDiv) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-number';
                errorDiv.textContent = `勘誤編號：${errorNum}`;
                cardAnswerDiv.appendChild(errorDiv);
            }
            
            expDiv.style.display = "block";
        }
        window.showContributionInput = function showContributionInput() {
             const contribArea = document.getElementById('contribution-area');
            const noExplanationMsg = document.getElementById('no-explanation-message');
            if (contribArea) {
                contribArea.style.display = 'flex';
                if(noExplanationMsg) noExplanationMsg.style.display = 'none';
                const textarea = document.getElementById('explanation-input');
                if(textarea) textarea.focus();
            }
        }
        function hideContributionInput() {
             const contribArea = document.getElementById('contribution-area');
            const noExplanationMsg = document.getElementById('no-explanation-message');
             const textarea = document.getElementById('explanation-input');
             const submitButton = document.getElementById('submit-explanation-button');

            if (contribArea) {
                contribArea.style.display = 'none';
                if (textarea) textarea.value = '';
                 if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('loading');
                 }
            }
             if (noExplanationMsg) {
                noExplanationMsg.style.display = 'inline';
                noExplanationMsg.innerHTML = '<i>感謝你的貢獻！</i>';
            }
        }
        function updateScoreDisplay() {
            const scoreDisplay = document.getElementById("score-display");
            if (scoreDisplay) scoreDisplay.textContent = score; 
            
            const correctEl = document.getElementById("correct");
            if (correctEl) correctEl.textContent = correct; 
            const wrongEl = document.getElementById("wrong");
            if (wrongEl) wrongEl.textContent = wrong; 
        }
        async function submitContribution() {
            let ip = 'unknown';
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                ip = ipData.ip;
            } catch (err) {
                console.error('取得 IP 失敗：', err);
            }
            const os = navigator.platform || 'Unknown OS';
            const ua = navigator.userAgent || '';
            let browser = 'Unknown Browser';
            if (ua.includes('Firefox')) {
                browser = 'Firefox';
            } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
                browser = 'Safari';
            } else if (ua.includes('Chrome')) {
                browser = 'Chrome';
            }
            const now = new Date();
            const hours12 = now.getHours() % 12 || 12;
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const period = now.getHours() >= 12 ? 'PM' : 'AM';
            const formattedDate = `${now.getMonth()+1}月${now.getDate()}日${hours12}:${minutes}${period}`;
            
            
            const playerNameForContrib = (window.currentPlayer && window.currentPlayer.trim() !== "") ? window.currentPlayer : "未設定名稱玩家";
            const contributorInfo = `${playerNameForContrib}[IP: ${ip}, ${os}, ${browser}]（${formattedDate}）：\n`;


            const explanationInput = document.getElementById('explanation-input');
            const explanation = explanationInput.value.trim();
            const submitButton = document.getElementById('submit-explanation-button');

            if (!explanation) {
                showAlertModal("請輸入詳解內容！");
                explanationInput.focus();
                return;
            }

            if (!data || data[x] === undefined) {
                showAlertModal("無法獲取當前問題資料，無法送出。");
                return;
            }

            if (submitButton) {
                submitButton.disabled = true;
                submitButton.classList.add('loading');
            }

            const currentItem = data[x];
            const num = currentItem.num || '';
            const path = currentItem.path || '';
            const answer = Array.isArray(currentItem.answer) ? currentItem.answer.join(' / ') : (currentItem.answer || '');
            const description = currentItem.description || '';
            const content = `${num},${path},${answer},${description},${explanation}`;

            console.log("Sending content:", content);
            const fullContent = contributorInfo + content;
            sendToGoogleDocs(fullContent);
            writeScore(10)
              .then(newTotalScore => { 
                if (typeof newTotalScore === 'number') score = newTotalScore;
                updateScoreDisplay(); 
                showAlertModal(`賺了10分！目前總分數：${newTotalScore}`);
              })
              .catch(err => console.error("寫入分數失敗：", err));
        }
        window.submitContribution = submitContribution;

        function nextProb() {
            console.log("[nextProb] Called. done:", JSON.parse(JSON.stringify(done)));
            if (done.every(d => d)) {
                console.log("[nextProb] All questions in current set are done. Handling end of round.");
                handleEndOfRound();
                return;
            }

            const showAnsDiv = document.getElementById("showAnswer");
            const existingSpeakButton = showAnsDiv.querySelector('.speak-answer-icon-button');
            if (existingSpeakButton) {
                existingSpeakButton.remove();
            }

            viewing = false;
            document.querySelector('.card-answer').style.display = 'none';
            document.querySelector('.answer-input-container').style.visibility = 'visible';
            document.querySelector('.bottom-buttons').style.visibility = 'visible';
            document.querySelector('.your-answer-label').style.visibility = 'visible';

            resetTime();
            countdown();
            
            const imageUpdated = updateImage();
            if (!imageUpdated && !done.every(d=>d)) { 
                console.error("[nextProb] Image not updated, but not all questions are done. This state should not be reached.");
                handleEndOfRound(); 
                return;
            }

            document.getElementById("answer").value = "";
            document.getElementById("answer").focus();
            const answerInput = document.getElementById("answer");
            const desc = data[x]?.description;
            if (desc && desc.trim() !== "") {
                answerInput.placeholder = desc;
            } else {
                adjustPlaceholder();
            }
            document.getElementById("showAnswer").innerHTML = "";
            document.getElementById("showExplanation").innerHTML = "";
            document.getElementById("showExplanation").style.display = "none";

            const savedCorrectList = JSON.parse(JSON.stringify(correctList));
            const savedWrongList = JSON.parse(JSON.stringify(wrongList));

            // Save progress to Firebase (Firebase only)
            const progressData = { data, x, done, correct, wrong, score, correctList: savedCorrectList, wrongList: savedWrongList, unitName: window.currentUnitName || undefined, jsonPath: window.currentJsonPath || undefined };
            
            if (window.currentUserUid) {
                // Save to Firebase if user is logged in
                saveProgressToFirebase(progressData).then(success => {
                    if (success) {
                        console.log("[nextProb] Saved progress to Firebase. x:", x, "correct (round):", correct, "wrong (round):", wrong, "score (total from Firebase):", score);
                    } else {
                        console.warn("[nextProb] Failed to save to Firebase");
                    }
                }).catch(error => {
                    console.error("[nextProb] Error saving to Firebase:", error);
                });
            }
            
            console.log("[nextProb] Saved correctList:", JSON.parse(JSON.stringify(savedCorrectList)));
            console.log("[nextProb] Saved wrongList:", JSON.parse(JSON.stringify(savedWrongList)));
            console.log("[nextProb] Exiting.");
        }
        function pickNewImage() {
            console.log("[pickNewImage] Called. Current 'done' array:", JSON.parse(JSON.stringify(done)));
            if (!questionQueue.length) {
                initializeQuestionQueue();
            }

            if (!questionQueue.length) {
                return -1;
            }

            const selectedIndex = questionQueue.shift();
            done[selectedIndex] = true;
            console.log(`[pickNewImage] Selected index: ${selectedIndex}. Updated 'done' array:`, JSON.parse(JSON.stringify(done)));
            preloadUpcomingImages();
            return selectedIndex;
        }
        function updateImage(isResuming = false) {
            console.log(`[updateImage] Called. isResuming: ${isResuming}. Current x: ${x}`);
             document.querySelector('.loading-screen').style.display = 'flex';
            var imageElement = document.getElementById("image");
            imageElement.classList.remove('loaded');
            imageElement.src = "";

            if (!isResuming) {
                const newX = pickNewImage();
                if (newX === -1) { 
                    console.log("[updateImage] pickNewImage returned -1, no more images in this set.");
                    document.querySelector('.loading-screen').style.display = 'none';
                    return false; 
                }
                x = newX;
            }

             if (x === -1 || data[x] === undefined) { 
                console.error(`[updateImage] Invalid question index or data. x: ${x}, data[x]:`, data[x]);
                document.querySelector('.loading-screen').style.display = 'none';
                return false; 
            }
            console.log(`[updateImage] Updating image for index x: ${x}. Item:`, JSON.parse(JSON.stringify(data[x])));

            const picref = data[x]?.path;

            if (picref) {
                 imageElement.setAttribute('src', picref);
                 const altText = data[x]?.answer?.[0] || `Parasite image ${x + 1}`;
                 imageElement.setAttribute('alt', `Image for: ${altText}`);
                 console.log(`[updateImage] Set image src to: ${picref}, alt: Image for: ${altText}`);
            } else {
                 console.warn(`[updateImage] No image path found for index ${x}.`);
                 imageElement.alt = "Image not available";
                 document.querySelector('.loading-screen').style.display = 'none';
            }
            console.log("[updateImage] Exiting.");
            // Update star button state after image changes
            try { updateStarButtonState(); } catch (e) {}
            return true; 
        }
        function countdown() { }
        function resetTime() { clearTimeout(tm); }
        function showWrongList() { displayListInModal(wrongList, "你答錯的"); }
        function showCorrectList() { displayListInModal(correctList, "你答對的"); }
        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            const stringValue = String(value);
            const escapeMap = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return stringValue.replace(/[&<>"']/g, match => escapeMap[match] || match);
        }
        function displayListInModal(list, title) {
            let modal = document.getElementById('modal');
            let modalBody = document.getElementById('modalBody');
            let content = `<h2>${title} (${list.length})</h2>`;

            if (list.length === 0) {
                content += `<p>你還沒有${title === "你答對的" ? "答對的" : "答錯的"}欸⋯</p>`;
            } else {
                content += '<ol>';
                list.forEach(item => {
                    if (!item) return;
                    content += '<li>';
                    const answers = Array.isArray(item.answer) ? item.answer : [];
                    const answerText = answers.length ? answers.join(' / ') : 'N/A';
                    const primaryAnswer = answers.length ? answers[0] : 'item';
                    if (item.path) {
                        const sanitizedPath = escapeHtml(item.path);
                        const sanitizedAlt = escapeHtml(primaryAnswer || 'item');
                        content += `<img src="${sanitizedPath}" loading="lazy" decoding="async" alt="Image for ${sanitizedAlt}" style="max-width: 200px; margin-bottom: 8px; border-radius: 4px;">`;
                    } else { content += '<p><i>（沒跑出圖片）</i></p>'; }
                    const sanitizedAnswer = escapeHtml(answerText);
                    content += `<p><strong>答案：</strong>${sanitizedAnswer}</p>`;
                    const explanationText = item.explanation?.trim();
                     if (explanationText && explanationText !== "\"\"" && explanationText !== "\"\"") {
                    const sanitizedExplanation = explanationText.replace(/<script.*?>.*?<\/script>/gi, '');
                    content += `<p style="font-size: 0.9rem; color: var(--text-secondary);"><em>解釋：</em>${sanitizedExplanation}</p>`;
                     }
                    const errataValue = item.num !== undefined && item.num !== null && String(item.num).trim() !== ''
                        ? String(item.num)
                        : 'N/A';
                    content += `<p class="modal-errata-number">勘誤編號：${escapeHtml(errataValue)}</p>`;
                    content += '</li>';
                });
                content += '</ol>';
            }
            modalBody.innerHTML = content;
            modal.style.display = "flex";
        }
        function adjustPlaceholder() {
            const inputElement = document.getElementById('answer');
            if (!inputElement) return;
            const desktopBreakpoint = 1024;
            if (window.innerWidth >= desktopBreakpoint) {
                inputElement.placeholder = '把答案打在這，你可以偷按按看 / 看看';
            } else {
                inputElement.placeholder = '把答案打在這';
            }
        }
        function showAlertModal(message) {
            const modal = document.getElementById('alertModal');
            const body = document.getElementById('alertModalBody');
            body.textContent = message;
            modal.style.display = 'flex';
            modal.style.opacity = '1';
            modal.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 500);
            }, 3000);
        }
        window.showAlertModal = showAlertModal;

        function showForgotPasswordLink() {
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            if (forgotPasswordLink) {
                forgotPasswordLink.style.display = 'inline';
                
                // 移除之前的事件监听器，避免重复绑定
                const newLink = forgotPasswordLink.cloneNode(true);
                forgotPasswordLink.parentNode.replaceChild(newLink, forgotPasswordLink);
                
                // 添加点击事件
                newLink.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const emailInput = document.getElementById('email');
                    const email = emailInput ? emailInput.value.trim() : '';
                    if (!email) {
                        showAlertModal('請先在 Email 欄位輸入您的 Email。');
                        return;
                    }
                    try {
                        await sendPasswordResetEmail(auth, email);
                        showAlertModal('已寄出重設密碼郵件，請至信箱查收。');
                    } catch (error) {
                        let msg = '寄送失敗，請稍後再試。';
                        switch (error.code) {
                            case 'auth/invalid-email':
                                msg = '電子郵件格式無效。';
                                break;
                            case 'auth/user-not-found':
                                msg = '找不到此電子郵件的帳戶。';
                                break;
                            case 'auth/too-many-requests':
                                msg = '嘗試次數過多，請稍後再試。';
                                break;
                        }
                        showAlertModal(msg);
                    }
                });
            }
        }
        
        function hideForgotPasswordLink() {
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            if (forgotPasswordLink) {
                forgotPasswordLink.style.display = 'none';
            }
        }

        function closeAlertModal() {
            document.getElementById('alertModal').style.display = 'none';
        }
        window.closeAlertModal = closeAlertModal;

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('alertModal');
            if (event.target === modal) {
                closeAlertModal();
            }
        });

        // 暱稱編輯模態框
        (function(){
            const nicknameModal = document.getElementById('nicknameModal');
            const closeNicknameModalBtn = document.getElementById('closeNicknameModal');
            const nicknameInput = document.getElementById('nicknameInput');
            const saveNicknameBtn = document.getElementById('saveNicknameBtn');

            function openNicknameModal(prefill) {
                if (nicknameInput) nicknameInput.value = prefill || '';
                if (nicknameModal) {
                    nicknameModal.style.display = 'flex';
                    nicknameModal.style.opacity = '1';
                }
            }
            function closeNicknameModal() {
                if (nicknameModal) nicknameModal.style.display = 'none';
            }
            window.openNicknameModal = openNicknameModal;

            if (closeNicknameModalBtn) {
                closeNicknameModalBtn.addEventListener('click', closeNicknameModal);
            }
            window.addEventListener('click', function(event) {
                if (event.target === nicknameModal) {
                    closeNicknameModal();
                }
            });
            if (saveNicknameBtn) {
                saveNicknameBtn.addEventListener('click', async () => {
                    const user = auth.currentUser;
                    if (!user) {
                        closeNicknameModal();
                        showAlertModal('請先登入');
                        return;
                    }
                    const raw = nicknameInput ? nicknameInput.value : '';
                    const trimmed = (raw || '').trim();
                    if (!trimmed) {
                        showAlertModal('暱稱不可為空');
                        return;
                    }
                    try {
                        await updateProfile(user, { displayName: trimmed });
                        try {
                            const uid = user.uid;
                            const userNodeRef = ref(db, `ntumedsa-quiz-histology-final/${uid}`);
                            await update(userNodeRef, { name: trimmed });
                        } catch (e) {
                            console.warn('同步更新排行榜名稱失敗：', e);
                        }
                        const currentNameSpan = document.getElementById('greetingName');
                        if (currentNameSpan) currentNameSpan.textContent = trimmed;
                        window.currentPlayer = trimmed;
                        if (typeof fetchLeaderboard === 'function') fetchLeaderboard();
                        closeNicknameModal();
                    } catch (err) {
                        console.error('更新暱稱失敗：', err);
                        showAlertModal('更新暱稱失敗');
                    }
                });
            }
        })();

        window.handleMainImageLoad = function handleMainImageLoad(imgElement) {
            if (!imgElement) return;
            imgElement.classList.add('loaded');
            const loadingScreen = document.querySelector('.loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }

            const attrSrc = imgElement.getAttribute('src');
            if (attrSrc) {
                preloadedImagePaths.add(attrSrc);
            }

            window.preloadNextImage();
        };

        window.preloadNextImage = function preloadNextImage() {
            preloadUpcomingImages();
        }
        
        // ===== Starred feature (Firebase only) =====
        let starredCache = {};
        function getCurrentItemKey(item) {
            if (!item) return null;
            if (item.num && String(item.num).trim() !== '') return `num:${String(item.num)}`;
            if (item.path && String(item.path).trim() !== '') return `path:${String(item.path)}`;
            return null;
        }
        async function loadStarredFromFirebase() {
            if (!window.currentUserUid) { starredCache = {}; return starredCache; }
            try {
                const starredRef = ref(db, `ntumedsa-quiz-histology-final/${window.currentUserUid}/starred/histology`);
                const snapshot = await get(starredRef);
                if (snapshot.exists()) {
                    const val = snapshot.val();
                    starredCache = (val && typeof val === 'object') ? val : {};
                } else {
                    starredCache = {};
                }
            } catch (e) {
                console.error('[starred] Failed to load from Firebase:', e);
                starredCache = {};
            }
            return starredCache;
        }
        async function saveStarredToFirebase(map) {
            if (!window.currentUserUid) return false;
            try {
                const starredRef = ref(db, `ntumedsa-quiz-histology-final/${window.currentUserUid}/starred/histology`);
                await set(starredRef, map || {});
                starredCache = map || {};
                return true;
            } catch (e) {
                console.error('[starred] Failed to save to Firebase:', e);
                return false;
            }
        }
        function isItemStarred(item) {
            const key = getCurrentItemKey(item);
            if (!key) return false;
            return !!starredCache[key];
        }
        async function setItemStarred(item, starred) {
            if (!window.currentUserUid) {
                showAlertModal('請先登入才能使用「星號」功能');
                return;
            }
            const key = getCurrentItemKey(item);
            if (!key) return;
            const nextMap = { ...(starredCache || {}) };
            if (starred) {
                nextMap[key] = {
                    num: item.num || '',
                    path: item.path || '',
                    answer: Array.isArray(item.answer) ? item.answer : [],
                    explanation: item.explanation || '',
                    description: item.description || ''
                };
            } else {
                delete nextMap[key];
            }
            await saveStarredToFirebase(nextMap);
        }
        function getAllStarredItems() {
            return Object.values(starredCache || {});
        }
        function updateStarButtonState() {
            const starBtn = document.getElementById('starToggle');
            if (!starBtn) return;
            const item = (typeof x !== 'undefined' && Array.isArray(data)) ? data[x] : null;
            if (!item) { starBtn.classList.remove('active'); starBtn.textContent = '☆'; return; }
            if (isItemStarred(item)) {
                starBtn.classList.add('active');
                starBtn.textContent = '★';
            } else {
                starBtn.classList.remove('active');
                starBtn.textContent = '☆';
            }
        }
        const starBtnEl = document.getElementById('starToggle');
        if (starBtnEl) {
            starBtnEl.addEventListener('click', async function() {
                const item = (typeof x !== 'undefined' && Array.isArray(data)) ? data[x] : null;
                if (!item) return;
                const nowStarred = !isItemStarred(item);
                await setItemStarred(item, nowStarred);
                updateStarButtonState();
            });
        }
        const openStarredTopBtn = document.getElementById('openStarredTop');
        if (openStarredTopBtn) {
            openStarredTopBtn.addEventListener('click', async function(){
                    // Load latest from Firebase before showing
                    if (window.currentUserUid) {
                        try { await loadStarredFromFirebase(); } catch (e) { console.warn('[starred] refresh failed:', e); }
                    }
                    const list = getAllStarredItems();
                    const body = document.getElementById('starredModalBody');
                    const modal = document.getElementById('starredModal');
                    let content = `<h2>已加星號 (${list.length})</h2>`;
                    if (list.length === 0) {
                        content += '<p>尚未加入任何星號。</p>';
                    } else {
                        content += '<ol>';
                        list.forEach(item => {
                            if (!item) return;
                            content += '<li style="cursor:pointer;" class="starred-entry">';
                            const answers = Array.isArray(item.answer) ? item.answer : [];
                            const answerText = answers.length ? answers.join(' / ') : 'N/A';
                            const primaryAnswer = answers.length ? answers[0] : 'item';
                            if (item.path) {
                                const sanitizedPath = escapeHtml(item.path);
                                const sanitizedAlt = escapeHtml(primaryAnswer || 'item');
                                content += `<img src="${sanitizedPath}" loading="lazy" decoding="async" alt="Image for ${sanitizedAlt}" style="max-width: 150px; height:auto; margin-bottom: 8px; border-radius: 4px;">`;
                            } else { content += '<p><i>（沒跑出圖片）</i></p>'; }
                            const sanitizedAnswer = escapeHtml(answerText);
                            content += `<p><strong>答案：</strong>${sanitizedAnswer}</p>`;
                            const explanationText = item.explanation?.trim();
                            if (explanationText && explanationText !== "\"\"" && explanationText !== "\"\"") {
                                const sanitizedExplanation = explanationText.replace(/<script.*?>.*?<\/script>/gi, '');
                                content += `<p style="font-size: 0.9rem; color: var(--text-secondary);"><em>解釋：</em>${sanitizedExplanation}</p>`;
                            }
                            const errataValue = item.num !== undefined && item.num !== null && String(item.num).trim() !== ''
                                ? String(item.num)
                                : 'N/A';
                            content += `<p class="modal-errata-number">勘誤編號：${escapeHtml(errataValue)}</p>`;
                            content += '</li>';
                        });
                        content += '</ol>';
                    }
                    content += `
                        <div style="margin: 10px 0 0 0; text-align:center;">
                            <button id="startStarredPractice" class="next-button" 
                            style="display:block; margin:0 auto;">
                            練習
                            </button>
                        </div>
                        `;
                    body.innerHTML = content;
                    modal.style.display = 'flex';
                    const practiceBtn = body.querySelector('#startStarredPractice');
                    if (practiceBtn) {
                        practiceBtn.addEventListener('click', async () => {
                            const items = getAllStarredItems();
                            if (!items || items.length === 0) {
                                showAlertModal("尚未加入任何星號。");
                                return;
                            }
                            if (!auth.currentUser) {
                                showAlertModal("請先登入！");
                                return;
                            }

                            // Close the modal and start a starred-only session
                            modal.style.display = 'none';

                            window.currentPlayer = (auth.currentUser.displayName || auth.currentUser.email || "使用者");
                            window.gameplayActive = true;

                            document.querySelector('.start-screen').style.display = 'none';
                            document.querySelector('.flashcard-container').style.display = 'flex';

                            state = 1;
                            correct = 0; wrong = 0; total = 0;
                            document.getElementById("correct").innerHTML = correct;
                            document.getElementById("wrong").innerHTML = wrong;
                            updateScoreDisplay();
                            correctList = []; wrongList = [];

                            const nextBtn = document.getElementById('next');
                            nextBtn.innerText = "下一個";
                            nextBtn.removeEventListener('click', startReviewWrong);
                            nextBtn.addEventListener('click', nextProb);

                            data = items;
                            numOfProbs = data.length;
                            data = parseMultiAns(data);
                            done = new Array(numOfProbs).fill(false);
                            resetPreloadState();
                            initializeQuestionQueue();
                            startGame();
                        });
                    }
                    const entries = body.querySelectorAll('.starred-entry');
                    const listCopy = getAllStarredItems();
                    entries.forEach((el, idx) => {
                        el.addEventListener('click', () => {
                            const item = listCopy[idx];
                            if (!item) return;
                            const imageModal = document.getElementById('imageModal');
                            if (typeof populateImageModal === 'function') {
                                populateImageModal(item);
                                imageModal.style.display = 'flex';
                                imageModal.style.opacity = '1';
                            }
                        });
                    });
            });
        }
        const closeStarredBtn = document.getElementById('closeStarredModal');
        if (closeStarredBtn) {
            closeStarredBtn.addEventListener('click', function() {
                const modal = document.getElementById('starredModal');
                modal.style.display = 'none';
            });
        }
    </script>

    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <span class="close-modal" id="closeLoginModal">&times;</span>
            <h2 id="modalTitle">登入</h2>
            <form class="login-form" id="loginForm">
                <input type="text" id="displayName" placeholder="暱稱" style="display: none;">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="密碼" required>
                <button type="submit" id="submitBtn">登入</button>
                <div class="or-divider"><span>或</span></div>
                <button type="button" id="googleSignInBtn" class="google-signin-btn" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 10px 12px; border: 1px solid var(--border-color, #e0e0e0); border-radius: 6px; background: #fff; color: #333; cursor: pointer;">
                    <span aria-hidden="true" style="display:inline-flex; width:18px; height:18px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 533.5 544.3">
                            <path fill="#4285F4" d="M533.5 278.4c0-18.6-1.6-37-4.9-54.8H272.1v103.7h146.9c-6.3 34-25.1 62.8-53.6 82v68.1h86.8c50.8-46.8 81.3-115.8 81.3-199z"/>
                            <path fill="#34A853" d="M272.1 544.3c72.9 0 134.1-24.1 178.8-65.3l-86.8-68.1c-24.1 16.2-55 25.8-92 25.8-70.7 0-130.6-47.7-152-111.8h-90.3v70.2c44.6 88.4 135.7 149.2 242.3 149.2z"/>
                            <path fill="#FBBC05" d="M120.1 325c-10.2-30.4-10.2-63.3 0-93.7v-70.2H29.8c-39.7 80-39.7 174.1 0 254.1L120.1 325z"/>
                            <path fill="#EA4335" d="M272.1 107.7c39.6-.6 77.8 14.5 106.6 42.2l79.6-79.6C406.2 24.8 340.2-1.2 272.1 0 165.6 0 74.5 60.8 29.8 149.2l90.3 70.2c21.4-64.1 81.3-111.7 152-111.7z"/>
                        </svg>
                    </span>
                    <span>使用Google登入</span>
                </button>
            </form>
            <div class="login-toggle">
                <span>還沒有帳號？</span>
                <a id="toggleMode">註冊</a>
                <a id="forgotPasswordLink" class="forgot-password-link" style="display: none;">忘記密碼？</a>
            </div>
        </div>
    </div>
</body>
</html>
